# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0
if {${subport} ne "gmpopenh264-plugin"} {
    PortGroup           meson 1.0
} else {
    set LTO_needs_pre_build yes
}
PortGroup               LTO 1.0

github.setup            cisco openh264 2.6.0 v
categories              multimedia
license                 BSD
maintainers             nomaintainer
platforms               darwin linux

description             Open-source H.264 codec
long_description        OpenH264 is a codec library which supports \
                        H.264 encoding and decoding.

checksums               rmd160  81968c7f3848b6432d320bdc178d7411bff14881 \
                        sha256  558544ad358283a7ab2930d69a9ceddf913f4a51ee9bf1bfb9e377322af81a69
#                         size    60302243
github.tarball_from     archive

if {${configure.build_arch} in [list i386 x86_64]} {
    depends_build-append \
                        port:nasm
}

# https://github.com/cisco/openh264/issues/3805
patchfiles-append       meson-build-do-not-hardcode-libc-on-darwin.diff

# Undefined symbols:
#  "__ZN7testing8internal23MakeAndRegisterTestInfoENSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEEPKcS8_S8_NS0_12CodeLocationEPKvPFvvESD_PNS0_15TestFactoryBaseE"
# Also required by gtest: https://github.com/cisco/openh264/issues/3807
compiler.cxx_standard   2017
configure.cxxflags-append \
                        -std=c++17

if {[string match *clang* ${configure.compiler}]} {
    configure.cxxflags-append \
                        -Wno-error=deprecated-declarations
}

subport gmpopenh264-plugin {}
if {${subport} eq "gmpopenh264-plugin"} {
    PortGroup           makefile 1.0
    PortGroup           save_configure_cmd 1.0

    platform darwin {
        PortGroup       legacysupport 1.1
        PortGroup       code_sign 1.0
        depends_build-append \
                        port:cctools
        # we don't actually need the legacysupport library!
        legacysupport.newest_darwin_requires_legacy -1
        # don't depend on anything in $prefix/lib ; link libc++ statically.
        legacysupport.use_static yes
        legacysupport.use_mp_libcxx yes

        configure.cflags-append \
                    -mmacosx-version-min=${macosx_deployment_target}
        configure.cxxflags-append \
                    -mmacosx-version-min=${macosx_deployment_target}
        pre-configure {
            if {[string match macports-gcc* ${configure.compiler}]} {
                ui_error "Building with GCC is not currently supported!"
                return -code error "Please use a clang compiler!"
            }
        }
    }


    long_description-append \
                        This port builds the gmpopenh264 plugin for FireFox.
    # we do install a "library" but it's a plugin for non-MacPorts applications
    installs_libs       no
    use_configure       no

    post-extract {
        system -W ${worksrcpath} "make gmp-bootstrap"
    }

    compwrap.add_compiler_flags yes

    configure.save_build_cmd install

    build.pre_args-replace \
                    all plugin
    build.post_args-append -k V=Yes

    destroot {
        set dest ${destroot}${prefix}/libexec/gmp-gmpopenh264/${version}
        xinstall -m 755 -d ${dest}
        if {${os.platform} eq "darwin"} {
            xinstall -m 755 ${worksrcpath}/libgmpopenh264.2.6.0.dylib ${dest}/libgmpopenh264.dylib
            codesign ${dest}/libgmpopenh264.dylib
        } else {
            xinstall -m 755 ${worksrcpath}/libgmpopenh264.so.2.6.0 ${dest}/libgmpopenh264.so
        }
        xinstall -m 644 ${worksrcpath}/gmpopenh264.info ${dest}/
    }

    return
}

depends_build-append    port:gtest

test.run                yes
