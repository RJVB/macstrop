# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.1
PortGroup           active_variants 1.1

set rustup.shim_cargo_portgroup yes
use_configure       0
default_variants    +rustup_build
PortGroup           rustup 1.0
PortGroup           save_configure_cmd 1.0
PortGroup           compress_workdir 1.0

github.setup        clone206 dsd2dxd 7b157111e58826f40c5d5916ca0023540b69a132
fetch.type          git
version             2.4.2
distname            ${name}-git

license             GPL-3.0
maintainers         openmaintainer
description         Converts DSD to PCM
platforms           darwin linux

categories          audio
long_description    \
Converts DSD to PCM on the command line with the following features:\n\
\n\
    Accepts single rate (dsd64), double rate (dsd128), or quad rate (dsd256) DSD as input.\n\
        .dsf and .dff files can be read from, including metadata.\n\
    Can output to an aiff, wav, or flac file.\n\
        Where possible, ID3v2 tags are copied to the destination files (when read from .dsf or .dff file that has them).\n\
    Can also read raw DSD bitstreams from standard in (stdin) and output raw PCM to standard out (stdout), so you can use piping/shell redirection to combine with other audio utilities on the command line.\n\
        Handles either planar format DSD (as found in .dsf files), or interleaved format DSD (as found in .dff files). Assumes block size (per channel) of 4096 bytes for planar, 1 byte for interleaved, unless otherwise specified with the below command line options.\n\
    Allows you to specify the type of dither to use on output\n\
    Output bit depth can be either 16, 20, or 24 fixed integer PCM, or 32 bit float PCM.\n\
        The dither will be optimised accordingly, including for 20 bit output.\n\
    Allows you to choose between different decimation filters.\n\
    Uses available CPU threads in parallel, with progress bars for each conversion.

patch.pre_args      -Np1
patchfiles          patch-test-scripts.diff

cargo.offline_cmd
build.pre_args-append --locked

configure.save_configure_cmd "install log"
configure.save_build_cmd     "install"

if {![variant_isset rustup_build]} {
    # this is just me being lazy:
    return -code error "+rustup_build must be used"
}

destroot {
    if {${os.platform} eq "darwin"} {
        xinstall -m 755 \
            ${worksrcpath}/target/[cargo.rust_platform]/release/${name} \
            ${destroot}${prefix}/bin
    } else {
        xinstall -m 755 \
            ${worksrcpath}/target/release/${name} \
            ${destroot}${prefix}/bin
    }
    xinstall -m 755 -d ${destroot}${prefix}/share/doc/${name}
    xinstall -m 644 \
            ${worksrcpath}/README.md \
            ${worksrcpath}/LICENSE.txt \
            ${destroot}${prefix}/share/doc/${name}/
}

test.run    yes
depends_test-append \
            port:ffmpeg8
pre-test {
    if {![file exists ${prefix}/bin/ffplay8]} {
        ui_error "port:ffmpeg8 must be installed with the +ffplay variant!"
        return -code error "Please install port:ffmpeg8+ffplay"
    }
}

test.env-append \
            DSD2DXD=${destroot}${prefix}/bin/dsd2dxd \
            FFPLAY=${prefix}/bin/ffplay8
test.cmd    ${worksrcpath}/run_all_tests.sh
test.target
