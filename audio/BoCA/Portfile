# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.1
PortGroup           makefile 1.0
compwrap.add_compiler_flags yes
PortGroup           LTO 1.0
PortGroup           save_configure_cmd 1.0

# Use commit for now due to several fixes from upstream, see:
# https://github.com/enzo1982/BoCA/issues/12
# https://github.com/enzo1982/BoCA/pull/13
git.shallow_since   2023-01-01
github.setup        enzo1982 BoCA 1f120b8748de136e8236233fe7ae40e69e32dbaa
fetch.type          git
version             1.0.7.49
distname            ${name}-git

categories          audio
license             GPL-2
maintainers         nomaintainer
description         The component framework behind the fre:ac audio converter.
long_description    ${name} provides unified interfaces for components like \
                    encoders, decoders, taggers and extensions as well as code \
                    to support communication between the application \
                    and its components.

homepage            https://www.freac.org

# Revert with the next release.
# github.tarball_from releases

depends_lib         port:expat \
                    port:libcdio \
                    port:libcdio-paranoia \
                    port:smooth \
                    port:uriparser \
                    port:gettext
platform linux {
    depends_lib-append \
                    port:pulseaudio
}

post-extract {
    file delete -force [glob -nocomplain ${worksrcpath}/system-*]
}

patchfiles          patch-set-install-path-runtime.diff \
                    patch-set-install-path-components.diff \
                    patch-never-wine.diff

makefile.prefix_name        prefix
compiler.blacklist-append   {clang < 600.0.57}

if {${build_arch} ne "arm64"} {
    build.args-append \
                    BUILD_ARM64=False
}
build.args-append   AR=${configure.ar} \
                    NM=${configure.nm} \
                    RANLIB=${configure.ranlib}

# port:ffmpeg pulls in a lot of dependencies we can also use
depends_run-append  port:ffmpeg

variant ffmpeg6 conflicts ffmpeg7 ffmpeg8 description {use FFmpeg6} {
    global ffmpeg
    depends_run-replace \
                    port:ffmpeg \
                    port:ffmpeg6
    set ffmpeg      ffmpeg6
}

variant ffmpeg7 conflicts ffmpeg6 ffmpeg8 description {use FFmpeg7} {
    global ffmpeg
    depends_run-replace \
                    port:ffmpeg \
                    port:ffmpeg7
    set ffmpeg      ffmpeg7
    ui_msg "set ffmpeg ${ffmpeg}"
}

variant ffmpeg8 conflicts ffmpeg6 ffmpeg7 description {use FFmpeg7} {
    global ffmpeg
    depends_run-replace \
                    port:ffmpeg \
                    port:ffmpeg8
    set ffmpeg      ffmpeg8
}

post-destroot {
    if {[info exists ffmpeg]} {
        foreach x [glob ${destroot}${prefix}/lib/boca/boca_decoder_ffmpeg*.xml] {
            reinplace "s|<command>ffmpeg</command>|<command>${ffmpeg}</command>|g" ${x}
        }
    }
}

github.livecheck.regex {([0-9.]+)}
