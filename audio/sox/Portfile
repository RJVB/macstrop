# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0
PortGroup       LTO 1.0
PortGroup       save_configure_cmd 1.0

name            sox
conflicts       play
version         14.4.2 ; revision 8
checksums       rmd160  738ac41a07f74f66e27cd642f786cc5815ca87ff \
                sha256  81a6956d4330e75b5827316e44ae381e6f1e8928003c6aa45896da9041ea149c
#                 size    935449

categories      audio
maintainers     nomaintainer
license         GPL-2+
platforms       darwin linux

description      the Swiss Army knife of audio manipulation
long_description \
	SoX (also known as Sound eXchange) translates sound samples between \
	different file formats, and optionally applies various sound \
	effects. SoX is intended as the Swiss Army knife of sound processing \
	tools. It doesn't do anything very well, but sooner or later it \
	comes in very handy.

homepage        https://sox.sourceforge.net
master_sites    sourceforge:project/sox/sox/${version}
use_bzip2       yes

depends_build   path:bin/pkg-config:pkgconfig

post-extract {
    if {![file exists ${worksrcpath}/configure.ac]} {
        # this is for +dsd; configure.ac comes from the sox github repo.
        xinstall -m 755 ${filespath}/configure.ac ${worksrcpath}/
    }
}

patch.pre_args  -Np1
patchfiles      curl.patch \
                yosemite-libtool.patch \
                warnings.patch

variant dsd description {support conversion to DSD} {}
if {[variant_isset dsd]} {
    depends_build-append \
                port:autoconf \
                port:automake \
                port:libtool
    patchfiles-append \
                patch-add-dsd-support.diff
    pre-configure {
        if {![file exists ${worksrcpath}/config.log]} {
            system -W ${worksrcpath} "autoreconf -fvi"
            # current autoconf doesn't require the yosemite patch.
        }
    }
}
default_variants-append \
                +dsd

platform darwin 11 {
	# System grep fails: "grep: Regular expression too big"
	depends_build-append	\
                port:grep
}

depends_lib	    port:libao \
                port:flac		\
                port:lame		\
                port:libgsm		\
                port:libiconv		\
                port:libid3tag		\
                port:libmad		\
                port:libmagic		\
                port:libogg		\
                port:libopus		\
                port:libpng		\
                port:libsndfile		\
                port:libvorbis		\
                port:opusfile		\
                port:twolame		\
                port:wavpack		\
                port:zlib

configure.args	--enable-largefile	\
                --disable-silent-libtool\
                --disable-silent-rules	\
                --disable-openmp	\
                --with-ladspa-path=${prefix}/lib/ladspa \
                --enable-symlinks
if {${os.platform} eq "darwin"} {
    configure.args-append \
                --without-libltdl	\
                --with-distro=macosx
} else {
    configure.args-append \
                --with-distro=${os.platform}
}

# additional formats
configure.args-append \
                --with-magic		\
                --with-png		\
                --with-mad		\
                --with-id3tag		\
                --with-lame		\
                --with-twolame		\
                --with-oggvorbis	\
                --with-opus		\
                --with-flac		\
                --without-amrwb		\
                --without-amrnb		\
                --with-wavpack		\
                --with-sndfile		\
                --with-mp3		\
                --with-gsm		\
                --with-lpc10

variant omp description {enable OpenMP support} {
    depends_lib-append \
                port:libomp
    configure.args-replace \
                --disable-openmp	\
                --enable-openmp
}

# output drivers
configure.args-append \
                --with-ao \
                --without-waveaudio	\
                --without-oss \
                --without-sunaudio

if {${os.platform} eq "darwin"} {
    configure.args-append \
                --with-coreaudio	\
                --without-sndio		\
                --without-alsa		\
                --without-pulseaudio
    variant pulse description {support output via PulseAudio} {
        depends_lib-append \
                port:pulseaudio
        configure.args-replace \
                --without-pulseaudio \
                --with-pulseaudio
    }
} else {
    depends_lib-append \
                port:alsa-lib \
                port:pulseaudio
    configure.args-append \
                --with-alsa		\
                --with-pulseaudio
}

build.post_args-append -wk
