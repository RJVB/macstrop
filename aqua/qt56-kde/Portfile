# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# kate: backspace-indents true; indent-pasted-text true; indent-width 4; keep-extra-spaces true; remove-trailing-spaces modified; replace-tabs true; replace-tabs-save true; syntax Tcl/Tk; tab-indents true; tab-width 4;
# Copyright (c) 2015, 2016 R.J.V. Bertin

PortSystem          1.0

set basename        qt56-kde
set namesuffix      ""
name                ${basename}${namesuffix}


set is_stubport     no
# Qt 5.4 will not build on OS X 10.6, so we provide 5.3 on that OS.
# The just-release Qt 5.5 release should build on OS X 10.7 (to be confirmed)
if {${os.platform} eq "darwin" && ${os.major} <= 10} {
    version         5.3.2
    set QT53        yes
} else {
    variant legacy description {Installs version 5.3.2 also on OS X 10.7+. Only for testing, please do not use.} {}
    if {[variant_isset legacy]} {
        version     5.3.2
        set QT53    yes
    } else {
        version     5.6.2
        set QT53    no
    }
}

#### revision magic
# platform darwin {
# example:
# (Qt 5.6.1 / 201610) this is for the now functional split-off of QtWebkit into its own proper subport
# if {${subport} eq "${name}" || ${subport} eq "${name}-qtwebkit"} {
#     revision        [expr ${revision} + 1]
# }
# }
if {${subport} eq "${name}" } {
    # revbump for moving the Assistant to a subport
    revision        [expr ${revision} + 1]
}
####

# set building_qt5 immediately, before including the Qt5 PortGroup!
set building_qt5    1
set qt5.prefer_kde  1
PortGroup           qt5 1.0

if {${subport} ne "${name}-qtwebengine"} {
    PortGroup       muniversal 1.0
}

if {![info exists qt5.using_kde] || !${qt5.using_kde}} {
    ui_error "Using port ${subport} without the corresponding Qt5 PortGroup"
    return -code error "Qt5 PortGroup mismatch"
}

# a convenience procedure to register conflicts among the different Qt5 ports:
# for instance: [qt5_port_conflicts {qtbase x11}]
proc qt5_port_conflicts {components} {
    global namesuffix available_qt5_versions
    set cnfls {}
    if {${namesuffix} eq ""} {
        set suffix "-devel"
    } else {
        set suffix ""
    }
    foreach comp ${components} {
        foreach {v info} ${available_qt5_versions} {
            if {${comp} ne "" && ${comp} ne "qtbase"} {
                set cnfls [lappend cnfls ${v}-${comp}]
                set cnfls [lappend cnfls ${v}-kde${suffix}-${comp}]
            } else {
                set cnfls [lappend cnfls ${v}-qtbase]
                set cnfls [lappend cnfls ${v}-kde${suffix}]
            }
        }
    }
    return ${cnfls}
}

# convenience replacement for the PortGroup procedure which can be used
# to include the qmake5 PG without re-including the Qt5-kde PG.
proc use_PortGroup {name vers} {
    uplevel namespace eval qt5 {set dont_include_twice yes}
    ui_debug "Including PortGroup ${name} ${vers}"
    uplevel PortGroup          ${name} ${vers}
    # if ${name} eq "qmake5" then dont_include_twice will already have been unset!
    if {[info exists qt5::dont_include_twice]} {
        uplevel namespace eval qt5 {unset dont_include_twice}
    }
}

### nothing to be seen from here on, move along :)

# optional support for HFS-compression of the source and build dirs
if {[file exists ${qt5::currentportgroupdir}/compress_workdir-1.0.tcl]} {
    PortGroup       compress_workdir 1.0
}

set branch          [join [lrange [split ${version} .] 0 1] .]
# minimal version variables:
if {[expr ${branch} >= 5.6]} {
    set QT56        yes
    set PPREF       ""
} else {
    set QT56        no
    set PPREF       qt532/
}

categories          aqua
platforms           macosx linux
maintainers         gmail.com:rjvbertin mk
license             {LGPL-2.1 GPL-3}

homepage            http://qt.io
description         Qt Tool Kit ${branch}, tuned for an improved KF5 experience
long_description    Qt Tool Kit: A cross-platform framework \
                    (headers, data, and libraries) for writing \
                    cross-platform GUI-based applications. This port uses an installation layout \
                    and includes a number of patches \
                    aimed at improving the KF5 experience (by supporting the selected KDE theme for instance), \
                    and enables useful backtraces into Qt code for debugging.\
                    It provides most of Qt in a single port rather than using port:qt5's one-component-per-subport approach. \
                    It does provide the same subports port:qt5 provides, as stubs. Installs to ${qt_dir}.\n\
                    This is Qt's "LTS" release, lacking certain features required by a growing number of KF5 applications. \
                    Please consider installing port:qt5-kde instead.\n\
                    For license info, see http://doc-snapshots.qt.io/qt5-${branch}/licenses-used-in-qt.html

platform darwin {
    notes-append    "Install port:kf5-osx-integration and set KDE_SESSION_VERSION to 4 or 5 in order to \
                    apply the theme/style selected for KF5 applications automatically in all Qt5 applications.\
                    What also should work (with any Qt5 version) is to set QT_QPA_PLATFORMTHEME=kde, but only osx-integration \
                    will provide support for icon themes in ${prefix}/share/icons.\n\n\
                    Also note that an increasing number of KF5 applications and components require a newer Qt5 version."
}

distname            qt-everywhere-opensource-src-${version}

master_sites        http://download.qt.io/official_releases/qt/${branch}/${version}/single/

use_xz              yes
if {${QT53}} {
    checksums       rmd160  e4664d55eb4cfb04e982d680602e4cdcd4f2ac05 \
                    sha256  7f5bf93344cb57bac374ea4a32c8eda87f1357f998f14278e717cf84d0289bf0
} else {
    if {${subport} ne "${name}-qtwebkit"} {
        distfiles \
                ${distname}${extract.suffix}
        checksums \
                rmd160  a00cda65216d8c04ab8434925d875baeff1ba8b1 \
                sha256  83e61bfc78bba230770704e828fa4d23fe3bbfdcfa4a8f5db37ce149731d89b3
    }
}

# Share the distfiles dir with port:qt5
dist_subdir         qt5

# be neat and put all --exclude extract exclusions before any specified components to extract
options             do_not_extract \
                    extract_components
default do_not_extract      {}
default extract_components  {}
proc collect_extract_args {} {
    foreach comp [option do_not_extract] {
        extract.post_args-append --exclude ${comp}
    }
    foreach comp [option extract_components] {
        extract.post_args-append ${comp}
    }
    ui_info "Excluding components: [option do_not_extract]"
    ui_info "Exclusive components: [option extract_components]"
}
pre-extract {
    collect_extract_args
}
extract.pre_args-append     -T 0
platform linux {
    if {[file exists ${prefix}/bin/bsdtar]} {
        extract.post_args | ${prefix}/bin/bsdtar --no-same-owner -xf -
    }
}

if {${os.platform} ne "darwin"} {
    if {[variant_isset universal]} {
        return -code error "The universal variant only makes sense on Darwin/OS X"
    }
}

if { ${os.platform} ne "darwin" } {
    # probably linux, violate MacPorts premises by allowing a build fully dependent
    # on system/host libraries.
    pre-fetch {
        ui_msg "On \"${os.platform}\" most dependencies are obtained from the host, expect unforeseen issues!!"
    }
} elseif { ${os.major} < 10 } {
    pre-fetch {
        ui_error "OS X prior to 10.7 (Lion) is not a Reference Configuration for Qt."
        ui_error "OS X prior to 10.6 (Snow Leopard) is not even tested."
        ui_error "See http://qt-project.org/doc/qt-5/supported-platforms.html#reference-configurations"
        return -code error "unsupported OS"
    }
} elseif { ${os.major} == 10 } {
    pre-fetch {
        ui_error "OS X prior to 10.7 (Lion) is not a Reference Configuration for Qt."
        ui_error "See http://qt-project.org/doc/qt-5/supported-platforms.html#reference-configurations"
        ui_error "Try installing port:qt53-kde with its patches to build Qt with a recent, non-Xcode clang version;"
        return -code error "unsupported OS"
    }
} elseif { ${os.major} > 16 } {
    pre-fetch {
        ui_warn "OS X subsequent to 10.12 (\"Sierra\") is not a Reference Configuration for Qt."
        ui_warn "See http://qt-project.org/doc/qt-5/supported-platforms.html#reference-configurations"
    }
} else {
    # 11 <= ${os.major} <= 13
    if { [variant_isset universal] } {
        pre-fetch {
            ui_warn "Multiple architectures is not a Reference Configuration for Qt."
            ui_warn "See http://qt-project.org/doc/qt-5/supported-platforms.html#reference-configurations"
        }
    } else {
        if { ${build_arch} eq "i386" } {
            pre-fetch {
                ui_warn "32-bit mode is not a Reference Configuration for Qt."
                ui_warn "See http://qt-project.org/doc/qt-5/supported-platforms.html#reference-configurations"
            }
        }
    }
}

if { ${subport} eq "${name}-zz-docs"  } {
    universal_variant   no
    installs_libs       no
} else {
    if { ![variant_isset universal] } {
        configure.args-append               "-platform ${qt_qmake_spec}"
    } else {
        set merger_configure_env(i386)      "QMAKESPEC=${qt_qmake_spec_32}"
        set merger_configure_env(x86_64)    "QMAKESPEC=${qt_qmake_spec_64}"
        set merger_configure_args(i386)     "-platform ${qt_qmake_spec_32}"
        set merger_configure_args(x86_64)   "-platform ${qt_qmake_spec_64}"
        set merger_arch_flag                yes
        set merger_arch_compiler            yes
    }
}


if {[info exists env(QTDIR)]} {
    ui_msg "unsetting \$QTDIR"
    unset env(QTDIR)
}

if {${QT53}} {
    set clang_versions {4.0 3.9 3.8 3.7 3.6 3.5 3.4}
    proc qt_cc {} {
        global prefix clang_versions
        foreach v ${clang_versions} {
            set cc "clang-mp-${v}"
            if {[file exists ${prefix}/bin/${cc}]} {
                return ${prefix}/bin/${cc}
            }
        }
        ui_error "\nNo compatible MacPorts clang compiler found. This is a bug, please report\n"
        return -code error "No compatible clang found in ${prefix}/bin"
    }
    proc qt_cxx {} {
        global prefix clang_versions
        foreach v ${clang_versions} {
            set cxx "clang++-mp-${v}"
            if {[file exists ${prefix}/bin/${cxx}]} {
                return ${prefix}/bin/${cxx}
            }
        }
        ui_error "\nNo compatible MacPorts clang++ compiler found. This is a bug, please report\n"
        return -code error "No compatible clang++ found in ${prefix}/bin"
    }
}

# these are set only when building Qt 5.3.2 on 10.6, but configure.cxx c.s.
# have a habit of changing behind our backs if we set them just on the toplevel.
# Try using a proc that can be invoked in every relevant pre-phase.
proc setQt53Compilers {} {
    global workpath configure.cc configure.cxx configure.objc configure.objcxx configure.compiler
    if {[file exists ${workpath}/build/qtbase/bin/clang]} {
        configure.cc        ${workpath}/build/qtbase/bin/clang
        configure.objc      ${workpath}/build/qtbase/bin/clang
        ui_info "Found (Obj)C compiler ${configure.cc}"
    }
    if {[file exists ${workpath}/build/qtbase/bin/clang++]} {
        #configure.compiler  ${workpath}/build/qtbase/bin/clang++
        configure.cxx       ${workpath}/build/qtbase/bin/clang++
        configure.objcxx    ${workpath}/build/qtbase/bin/clang++
        ui_info "Found (Obj)C++ compiler ${configure.cxx}"
    }
}
setQt53Compilers

if {!${QT53}} {
    patch.pre_args      -Np1
}

if {${subport} eq ${name}} {
#     PortGroup           select 1.0
#     select.group        qt
#     select.file         ${filespath}/qt5-kde
    if {${os.platform} eq "darwin"} {
        variant abort description {this variant provides qFatal's standard behaviour of calling abort(2) instead of quitting with an alert dialog} {}
    }
#     if {${QT56} && [info exists qtwebkit_is_stub]} {
#         snip
#     }
}

set CXX                     [file tail ${configure.cxx}]
set CXX_dir                 [file dirname ${configure.cxx}]
set CXX_parts               [split ${CXX} -]
set CXX_family              [lindex ${CXX_parts} 0]
set CXX_mp                  [expr {[lindex ${CXX_parts} 1] eq "mp"}]
set CXX_vsuffix             [join [lrange ${CXX_parts} 1 end] -]
unset CXX_parts

if { ${subport} eq ${name} || ${subport} eq "${name}-zz-docs" || ${subport} eq "${name}-x11"} {
    # use the qt5 group; set 'building_qt5' so that the portgroup
    # does not include certain parts
    conflicts-append    qt3 qt3-mac [qt5_port_conflicts {qtbase x11}]
    PortGroup           xcodeversion 1.0

    minimum_xcodeversions   {10 3.2}

    use_parallel_build  yes

    # as yet untested check copied from port:qt5
    if {${os.platform} eq "darwin" && ${configure.compiler} ne "clang"} {
        if {[string match macports-clang-* ${configure.compiler}] && [vercmp ${xcodeversion} "7.0"] >= 0} {
            # non-Xcode clang does not seem to be able to understand tbd files
            # for an explanation of tbd files, see
            #    http://stackoverflow.com/questions/31450690/why-xcode-7-shows-tbd-instead-of-dylib
            # see https://trac.macports.org/ticket/53151
            pre-fetch {
                ui_error "This configuration is known to fail"
                ui_error "See https://trac.macports.org/ticket/53151"
                ui_error "As a workaround, do not set configure.compiler manually"
                return -code error "incompatible configuration"
            }
        }
    }

    if {${QT53}} {
        # header file QtCore/private/qmachparser_p.h is included only if "defined(QT_BUILD_INTERNAL) && defined(Q_OF_MACH_O)"
        #     code from header is used only "ifdef Q_OF_MACH_O"
        #     the two must be consistent
        #     assume the header include code is correct
        patchfiles-append qt532/patch-tst_qpluginloader.diff
    }

    # When testing, ensure that a universal object file is not created inadvertently.
    patchfiles-append ${PPREF}patch-machtest.diff

    # see http://stackoverflow.com/questions/14506151/invalid-symbol-redefinition-in-inline-asm-on-llvm
    patchfiles-append ${PPREF}patch-tst_benchlibcallgrind.diff

    if {${subport} ne "${name}-x11"} {
        # see #44934 (and #35067 for the qt4-mac version)
        patchfiles-append ${PPREF}patch-shared.diff
        if {${QT53}} {
            # see https://bugreports.qt-project.org/browse/QTBUG-41136
            patchfiles-append qt532/patch-avfmediaplayersession.diff
        }
    }

    if {${QT53}} {
        # see https://bugreports.qt-project.org/browse/QTBUG-41367
        patchfiles-append   qt532/patch-qmacstyle_mac.diff
        patchfiles-append   qt532/fix-qsp_fontlocations.patch
        ## TODO : backport the qsp_xdg (qmake) / QspXDG (cmake) activators ##
        patchfiles-append   qt532/fix-qstandardpaths3.patch
        patchfiles-append   qt532/patch-missing-autoreleasepools.diff
        if {[variant_isset legacy]} {
            # this is probably not required on 10.6 (I can't remember it was)
            patchfiles-append \
                            qt532/patch-lalr.diff
        }
    } else {
        # Mac menu items shouldn't have icons according to the HIG (and I agree)
        patchfiles-append       ${PPREF}patch-no-icons-in-menus.diff
        # don't let configure use pkg-config to find OpenGL if building for Cocoa
        # (the patch tests for the selected QPA so is xcb-safe.)
        patchfiles-append   ${PPREF}patch-configure-find-opengl-and-correct-rpath.diff
        # correct the font directories returned by QStandardPaths (incorporated into the qsp patch #4):
        # patchfiles-append   fix-qsp_fontlocations.patch
        # patch QStandardPaths so that it can optionally return XDG-compliant locations
        # the patch of headers.pri is in a separate file because it contains very long lines.
        # The linux patch is safe to apply on OS X and probably required on FreeBSD
        patchfiles-append   ${PPREF}fix-qstandardpaths6.patch \
                            ${PPREF}fix-qstandardpaths-headerspri.patch \
                            ${PPREF}fix-qstandardpaths-linux.patch \
                            ${PPREF}patch-lookup-css-monospace-font.diff
        if {${os.platform} eq "linux"} {
            post-patch {
                # build the QspXDG activator CMake stuff even if it doesn't do anything on Linux
                reinplace "s|mac : SUBDIRS += src_qsp_xdg|SUBDIRS += src_qsp_xdg|g" ${worksrcpath}/qtbase/src/src.pro
            }
        }
        # patch qtpaths and qtdiag:
        if {${subport} eq "${name}"} {
            patchfiles-append   ${PPREF}patch-qtdiag-all-locations-and-qspmode.diff \
                                ${PPREF}patch-qtpaths-all-locations.diff
            if {${os.platform} eq "darwin"} {
                patchfiles-append \
                                ${PPREF}patch-qtpaths-qspmode.diff
            }
        }
        # https://bugreports.qt.io/browse/QTBUG-31034 and https://bugreports.qt.io/browse/QTBUG-31034?focusedCommentId=277009
        patchfiles-append   ${PPREF}patch-missing-autoreleasepools.diff

        # these enable automatic loading of a KDE platform theme plugin
        patchfiles-append   ${PPREF}patch-enable-qgenericunixthemes.diff \
                            ${PPREF}patch-enable-qgenericunixservices.diff
        # and this one if probably required because of adding the genericunix stuff:
        patchfiles-append   ${PPREF}patch-enable-fontconfig.diff

        # 2 more reported bugs
        patchfiles-append   ${PPREF}patch-nonull-setAsDockMenu.diff \
                            ${PPREF}patch-qkqueuefilesystemwatcher_addPaths.diff
        # https://bugreports.qt.io/browse/QTBUG-49887 ; a bit overzealous!
        #patchfiles-append   ${PPREF}patch-qpbutton-noshowicon.diff
    }
    if {!${QT53}} {
        # don't unload plugins on exit: https://codereview.qt-project.org/140750
        patchfiles-append   ${PPREF}patch-dont-unload-plugins.diff

        # make sure the private headers are always found through the CMake files,
        # even in an out-of-tree build
        patchfiles-append ${PPREF}always_include_private_headers.diff

        # print out some more info when warning about a menu item already added somewhere else
        patchfiles-append ${PPREF}patch-better-menuitem-insert-warning.diff

        # it's not Qt's role to inform the user constantly if s/he removed fonts that are in Apple's fallback font list
        patchfiles-append ${PPREF}dont-warn-missing-fallback-fonts.patch
    }

    # patches from Ubuntu 5.3.2+dfsg-4ubuntu8 (from Vivid Vervet)
    patchfiles-append           ${PPREF}remove_icon_from_example.patch \
                                ${PPREF}remove_google_adsense.patch
    if {${QT53}} {
        # patches remove_icon_from_example and remove_google_adsense are identical for Qt 5.4 and Qt 5.3.2
        patchfiles-append       qt532/gnukfreebsd.diff \
                                qt532/fix_bug_in_internal_comparison_operator.patch \
                                qt532/fix_sparc_atomics.patch \
                                qt532/load_testability_from_env_var.patch \
                                qt532/dbus_correct_signal_name_disconnect.patch \
                                qt532/Fix-crash-in-QNetworkAccessCacheBackend-closeDownstr.patch \
                                qt532/Don-t-always-chmod-the-XDG_RUNTIME_DIR.patch \
                                qt532/Report-the-system-error-on-why-chmod-2-failed-in-XDG.patch \
                                qt532/disable-generic-plugin-when-others-available.patch \
                                qt532/update-QtBearer-NetworkManager-backend-API.patch \
                                qt532/Reset-QNAM-s-NetworkConfiguration-when-state-changes.patch \
                                qt532/Use-a-property-cache-to-cut-down-on-blocking-calls.patch \
                                qt532/QtBearer-networkmanager-make-sure-to-set-flag-Active.patch \
                                qt532/Always-lock-the-DBus-dispatcher-before-dbus_connecti.patch \
                                qt532/QDBusConnection-Merge-the-dispatch-and-the-watch-and.patch \
                                qt532/Partially-revert-Fix-a-deadlock-introduced-by-the-ra.patch \
                                qt532/Break-after-handling-the-read-write.patch
    } else {
        patchfiles-append       ${PPREF}load_testability_from_env_var.patch \
                                ${PPREF}disable-generic-plugin-when-others-available.patch
    }

    if {${subport} eq ${name} && ${os.platform} eq "darwin"} {
        if {![variant_isset abort]} {
            if {${QT53}} {
                patchfiles-append   qt532/patch-qFatal-no-abort.diff
            } else {
                patchfiles-append   ${PPREF}patch-qFatal-no-abort.diff
            }
        }
        if {!${QT53}} {
            patchfiles-append   ${PPREF}patch-qmenuAddSection.diff
        }
    }

    if {${QT53}} {
        patchfiles-append   qt532/patch-improve-fontweight-support8.diff \
                            ${PPREF}patch-fontpanel.diff
    } else {
        patchfiles-append   ${PPREF}patch-improve-fontweight-support9.diff \
                            ${PPREF}patch-fontpanel.diff
    }

    platform darwin {
        if {!${QT53}} {
#             # For KDE: support XDG icon themes when QSP is in XDG-compliant mode
#             patchfiles-append   ${PPREF}patch-cocoatheme-icontheme-support.diff
#             depends_run-append  port:ciment-icons
            patchfiles-append   ${PPREF}patch-respect-DontSwapCtrlMeta.diff
        }
    }

    if {!${QT53}} {
        # https://codereview.qt-project.org/124643/
        # starting with Freetype font rendering: -platform cocoa:fontengine=freetype
        patchfiles-append   ${PPREF}patch-fix-build-when-system-freetype-is-detected.diff
        # fix font colour due to inappropriate gamma
        patchfiles-append   ${PPREF}patch-freetype-gamma-cocoa.diff
        patchfiles-append   ${PPREF}patch-silence-qnsview-warnings.diff \
                            ${PPREF}patch-silence-qpixmap-warnings.diff \
                            ${PPREF}patch-silence-setscreen-warning.diff
        # do not omit pkg-config files:
        # https://codereview.qt-project.org/#/c/140954/
        # https://github.com/Homebrew/legacy-homebrew/commit/620baaf10c957875d9d2b958343456f0d35d15fc
        patchfiles-append   ${PPREF}patch-restore-pc-files.diff

        # https://codereview.qt-project.org/157488 + https://codereview.qt-project.org/161056
        patchfiles-append   ${PPREF}patch-fix-dbus-crash-at-exit.diff
        if {${subport} eq "${name}"} {
            # https://codereview.qt-project.org/#/c/172619/
            patchfiles-append \
                            ${PPREF}patch-qtconn-for-10.12.diff \
                            ${PPREF}patch-qttools-skip-assistant.diff
        }
    }

    # --prefix is not recognised.
    configure.pre_args-delete       --prefix=${prefix}

    # --disable-dependency-tracking is not recognised.
    configure.universal_args-delete --disable-dependency-tracking

    # taken from the qt4-mac Portfile:
    global OSX_MINOR
    set OSX_MINOR ""
    # hopefully the MACOSX_DEPLOYMENT_TARGET exists and is set by now.  if
    # not, last resort (which is not desirable) is to use the os.version.
    if {${macosx_deployment_target} ne ""} {
        set OSX_MINOR [lindex [split ${macosx_deployment_target} "."] 1]
    } else {
        set OSX_MINOR [expr ${os.major} - 4]
    }

    if {${os.platform} eq "darwin"} {
        if {${configure.sdkroot} ne ""} {
            ui_debug "Using SDK from configure.sdkroot= ${configure.sdkroot}"
            configure.args-append \
                -sdk [string tolower [join [lrange [split [lindex [split ${configure.sdkroot} "/"] end] "."] 0 end-1] "."]]
        } else {
            # default: build for the current OS version, requesting the corresponding SDK explicitly
            if {[catch {exec xcrun --show-sdk-path -sdk macosx10.${OSX_MINOR}} result]} {
                ui_debug "Couldn't find preferred SDK macosx10.${OSX_MINOR}: ${result}"
                # the preferred matching SDK isn't available; check if the default SDK is
                set SDK [exec xcrun -show-sdk-version]
                if {[catch {exec xcrun --show-sdk-path -sdk macosx${SDK}} result]} {
                    ui_msg "Couldn't find the preferred nor a SDK macosx${SDK}: ${result}"
                    ui_msg "WARNING: this has been known to lead to build errors"
                } else {
                    ui_debug "Using default SDK macosx${SDK}"
                    configure.args-append \
                            -sdk macosx${SDK}
                }
            } else {
                ui_debug "Using SDK macosx10.${OSX_MINOR} : ${result}"
                configure.args-append \
                        -sdk [string tolower "macosx10.${OSX_MINOR}"]
            }
        }
    }

    # NB: -prefix->${prefix} !
    configure.args-append                      \
        -prefix         ${prefix}              \
        -archdatadir    ${qt_dir}              \
        -docdir         ${qt_docs_dir}         \
        -headerdir      ${qt_includes_dir}     \
        -plugindir      ${qt_plugins_dir}      \
        -importdir      ${qt_imports_dir}      \
        -qmldir         ${qt_qml_dir}          \
        -datadir        ${qt_data_dir}         \
        -libdir         ${qt_frameworks_dir}   \
        -bindir         ${qt_bins_dir}         \
        -libexecdir     ${qt_dir}/libexec      \
        -translationdir ${qt_translations_dir} \
        -sysconfdir     ${qt_sysconf_dir}      \
        -examplesdir    ${qt_examples_dir}     \
        -testsdir       ${qt_tests_dir}        \
        -hostbindir     ${qt_bins_dir}         \
        -hostlibdir     ${qt_frameworks_dir}   \
        -hostdatadir    ${qt_host_data_dir}

# Configure options:

    # set up things for an out-of-source build:
    default configure.dir   {${workpath}/build}
    default build.dir       {${workpath}/build}
    if {${subport} eq "${name}-x11"} {
        #default configure.cmd   {../${worksrcdir}/qtbase/configure}
        default configure.cmd   {../${worksrcdir}/configure}
    } else {
        default configure.cmd   {../${worksrcdir}/configure}
    }

    configure.args-append \
        -v                \
        -release          \
        -opensource       \
        -confirm-license  \
        -shared

    if {${os.platform} eq "darwin"} {
        configure.args-append   \
            -force-pkg-config   \
            -no-evdev           \
            -no-linuxfb         \
            -no-kms             \
            -framework          \
            -no-rpath

        # Third Party Libraries:
        configure.args-append \
            -no-pulseaudio    \
            -no-mtdev         \
            -no-harfbuzz      \
            -openssl-linked   \
            -no-xinput2       \
            -no-xcb           \
            -no-xcb-xlib

        # configure options that don't show up in configure --help
        configure.args-append \
            -no-libudev       \
            -no-egl
        if {!${QT53}} {
            configure.args-append \
                -no-libproxy
            if {${os.major} <= 13} {
                configure.args-append \
                    -c++std "c++11"
            }
        } else {
            configure.args-append \
                -no-c++11
        }
    } else {
        configure.args-delete  \
            -libdir         ${qt_frameworks_dir}   \
            -hostlibdir     ${qt_frameworks_dir}
        configure.args-append  \
            -libdir         ${qt_libs_dir}          \
            -hostlibdir     ${qt_libs_dir}
        # presume we want to build the xcb version.
        configure.args-append   \
            -xcb -xcb-xlib      \
            -qpa xcb            \
            -rpath              \
            -R ${prefix}/lib    \
            -R ${qt_libs_dir}   \
            -no-reduce-relocations
        # to avoid multiarch issues on Debuntu, we force the use of the system pkg-config
	   # (hardwired to /usr/bin/pkg-config) and tell it to look in our pkgconfig dir too (=first)
        set PKG_CONFIG_PATH "${prefix}/lib/pkgconfig"
        configure.env-append    \
            PKG_CONFIG_PATH=${PKG_CONFIG_PATH} PKG_CONFIG=/usr/bin/pkg-config
        build.env-append        \
            PKG_CONFIG_PATH=${PKG_CONFIG_PATH} PKG_CONFIG=/usr/bin/pkg-config
        if {${os.platform} eq "linux"} {
            patchfiles-append   \
                ${PPREF}patch-configure-for-linux.diff
            post-patch {
                reinplace "s/mac|/linux|mac|/g" ${worksrcpath}/qtbase/config.tests/unix/iconv/iconv.pro
            }
        }
    }

# Additional options:
    configure.args-append    \
        {-make libs}         \
        {-make tools}        \
        {-nomake examples}   \
        {-nomake tests}      \
        -verbose             \
        -no-pch              \
        -cups                \
        -iconv               \
        -icu                 \
        -fontconfig          \
        -dbus-linked         \
        -glib                \
        -no-directfb
	if {!${QT53}} {
        configure.args-append   -no-use-gold-linker
	}

    configure.args-append       -optimized-qmake

    # the sqlite3 ("sqlite") and mysql plugins have been re-absorbed into the main port
    configure.args-append       -system-sqlite
    if {${os.platform} eq "darwin"} {
        depends_lib-append      port:sqlite3
    }
    foreach driver { db2 ibase oci odbc psql sqlite2 tds } {
        configure.args-append   -no-sql-${driver}
    }


    if {${subport} eq "${name}-x11"} {
        patchfiles-delete       ${PPREF}patch-fontpanel.diff
        patchfiles-append       ${PPREF}patch-to-build-xcb.diff
        post-patch {
            # this may already have been done in patch-enable-qgenericunixservices.diff
            reinplace -W ${worksrcpath}/qtbase/src "s|unix:!mac|unix|g" platformsupport/services/services.pri
            if {!${QT53}} {
                # avoid introducing dependencies on the OpenGL frameworks; that means not building the cocoa QPA
                # which is fine because we don't need it (and it's already installed).
                reinplace -W ${worksrcpath}/qtbase/src "s|mac:|cocoa:|g" platformsupport/cglconvenience/cglconvenience.pri
                reinplace -W ${worksrcpath}/qtbase/src "s|mac |cocoa |g" plugins/platforms/platforms.pro
            }
        }
        configure.args-delete   -no-xinput2 -no-xcb -no-xcb-xlib
        configure.args-append   -xcb -xcb-xlib -qpa xcb
        if {${QT53}} {
            configure.args-append \
                                -I ${prefix}/include -L ${prefix}/lib
            patchfiles-append   qt532/patch-xcb-XOpenGL.diff \
                                qt532/patch-xcb-missing-functions.diff
        } else {
            patchfiles-append   ${PPREF}patch-xcb-XOpenGL-full.diff
        }
    } else {
        # make sure that the Designer doesn't try to use a global menubar when using the xcb plugin.
        # Yes, this patch has to be applied when building the master port, not the xcb plugin subport...
        patchfiles-append       ${PPREF}patch-designer-show-menubar-on-xcb.diff
                # configure options that don't show up in configure --help
        if {${os.platform} eq "darwin"} {
            # openvg makes sense only when using X11 ...
            configure.args-append   -no-openvg
        }
    }

    if {${os.platform} eq "darwin"} {
        if {${QT53}} {
            # Some extra blackish magic to get Qt 5.3.2 to build on OS X 10.6, using a recent clang version.
            patchfiles-append       qt532/patch-configure-allow-macports-binutils.diff \
                                    qt532/patch-nistest.diff \
                                    qt532/patch-icutest.pro.diff \
                                    qt532/patch-clangconf.diff
            if {${subport} ne "${name}-x11" && ${subport} ne "${name}-zz-docs"} {
                patchfiles-append   qt532/patch-geoclue-gvalue-init.diff
            }
            patchfiles-append       qt532/patch-sdk.prf-no-xcrun.diff
            # a hackery bit of post-patch to be done pre-configure
            # (or post-patch, so it can be checked before running configure)
            post-patch {
                xinstall -m 755 -d ${workpath}/build/qtbase
                xinstall -m 755 -d ${workpath}/build/qtbase/bin
                # take some measures to pick the appropriate clang compiler. The compiler_blacklist portgroup and MacPorts based
                # have already introduced a dependency on clang-3.5 (unless clang-3.4 is installed?!). We create symlinks to clang
                # 3.4 or 3.5 in our build tree, so that the user doesn't have to do a `port select` for us.
                if {![file exists ${workpath}/build/qtbase/bin/clang++]} {
                    ln -s [qt_cc] ${workpath}/build/qtbase/bin/clang
                    ln -s [qt_cxx] ${workpath}/build/qtbase/bin/clang++
                }
                # instruct the build system to use these for building:
                reinplace -W ${worksrcpath}/qtbase/mkspecs/common "s|macportsclang|${workpath}/build/qtbase/bin/clang|g" clang.conf
                reinplace -W ${worksrcpath}/qtbase "s|PREFIX|${prefix}|g" config.tests/unix/icu/icu.pro
                # the configure script will build a bootstrap qmake executable respecting our mkspec (macx-clang referring to a MacPorts clang version)
                # because we patched it to do just that (patch-configure-allow-macports-binutils.diff).
                # We also provide an appropriate .qmake.stash to be sure that qmake doesn't generate a less appropriate one (despite the sdk.prf patch)
                # NB: this issue also hampers the universal build of the qtwebengine subport.
                if {![file exists ${workpath}/build/qtbase/.qmake.stash]} {
                    file copy ${filespath}/qt532/qmake.stash.in ${workpath}/build/qtbase/.qmake.stash
                }
                reinplace -W ${workpath}/build/qtbase "s|PREFIX/bin/clang|${workpath}/build/qtbase/bin/clang|g" .qmake.stash
                reinplace -W ${workpath}/build/qtbase "s|PREFIX|${prefix}|g" .qmake.stash
                # put a copy at the build root, which will be required for building qtwebkit
                # (way ahead in the future...)
                if {![file exists ${workpath}/build/.qmake.stash]} {
                    file copy ${workpath}/build/qtbase/.qmake.stash ${workpath}/build
                }
                if {[file exists ${worksrcpath}/qtwebkit/Source/WebCore/bindings/scripts/CodeGeneratorObjC.pm]} {
                    reinplace "s|/usr/bin/clang|${workpath}/build/qtbase/bin/clang|g" \
                                ${worksrcpath}/qtwebkit/Source/WebCore/bindings/scripts/CodeGeneratorObjC.pm
                }
                ui_msg "Everything is set up to use the Qt-specific compiler symlink ${workpath}/build/qtbase/bin/clang++\
                        but the build system will probably resolve the actual compiler to which this link points ([qt_cxx]).\
                        That is of no consequence; future Qt5 ports will use the Qt compiler in ${qt_bins_dir}."
            }
            configure.args-append   -process
        } else {
            # We don't want qmake to 2nd-guess the compiler we specify in our mkspec and
            # replace it with an Xcode compiler determined by xcrun.
            # 20150723: also exclude the QMAKE_LINK commands from being determined by xcrun
            patchfiles-append       ${PPREF}patch-sdk.prf-xcrun-not-for-compilers.diff
        }
    }

    # Qt builds part of the system using environment provided by MacPorts.
    # It builds the rest using its own internal environment.
    # For consistency, clear MacPorts environment.
    configure.cxx_stdlib
        configure.sdkroot
        configure.cc_archflags
        configure.cxx_archflags
        configure.objc_archflags
        configure.objcxx_archflags
        configure.ld_archflags
        configure.cppflags
        configure.objcflags-append  "-g"
        configure.objcxxflags-append  "-g"
        configure.pipe  no
    configure.march
        configure.mtune
        configure.universal_ldflags
        configure.universal_cflags
        configure.universal_cxxflags
        configure.universal_cppflags

    # patches for improving the KDE experience (and facilitating debugging)
    patchfiles-append       ${PPREF}patch-enable-dumpObjectInfo.diff
    if {${QT53}} {
        patchfiles-append   qt532/correct-systraymenu-iconhandling.patch \
                            qt532/deactivate-menurole-heuristics.patch \
                            qt532/debug-negative-qtimerint.patch
    } else {
        patchfiles-append   ${PPREF}deactivate-menurole-heuristics.patch \
                            ${PPREF}debug-negative-qtimerint.patch
    }

    configure.args-append   -force-debug-info -no-strip -no-separate-debug-info
}

# finish up building preparations
if { (${subport} eq ${name}) \
    || (${subport} eq "${name}-x11") || (${subport} eq "${name}-qtwebengine") } {

    if {${QT53} && [variant_isset LTO]} {
        ui_msg "The LTO variant is currently ignored for Qt 5.3"
    }
    if {[variant_isset LTO] && ${os.platform} eq "darwin"} {
        if {(${os.major} <= 13) || ${CXX_mp}} {
            patchfiles-append       ${PPREF}patch-clangconf-lto-commands.diff
        }
    }
    configure.ldflags-append        ${configure.optflags}

    if {${os.platform} eq "darwin"} {
        depends_lib-append                       \
            port:zlib                            \
            port:libpng                          \
            port:jpeg                            \
            port:freetype                        \
            port:fontconfig                      \
            path:bin/dbus-daemon:dbus            \
            port:openssl                         \
            port:tiff                            \
            port:libmng                          \
            path:lib/pkgconfig/glib-2.0.pc:glib2 \
            port:icu                             \
            port:pcre                            \
            port:libiconv
    } else {
        depends_build-append \
            port:tiff-dev
        depends_lib-append                       \
            port:zlib                            \
            port:libpng                          \
            port:jpeg                            \
            port:openssl                         \
            port:tiff                            \
            port:openal-soft                     \
            port:pcre
        configure.ldflags-delete    -Wl,-headerpad_max_install_names
    }

    platform darwin {
        do_not_extract-append       ${distname}/qtwayland
    }
    if {${subport} ne "${name}-qtwebengine"} {
        do_not_extract-append       ${distname}/qtwebengine
    }
    if {${subport} ne "${name}-qtwebview"} {
        do_not_extract-append       ${distname}/qtwebview
    }

    post-extract {
        file mkdir ${workpath}/build
        if {${subport} eq "${name}-qtwebengine"} {
            file delete -force ${worksrcpath}/qtwebengine/examples
        } else {
            if {[file exists ${worksrcpath}/qtwebengine] && (${subport} ne "${name}-zz-docs")} {
                file delete -force ${worksrcpath}/qtwebengine
                patchfiles-append   ${PPREF}patch-disable-qtwebengine.diff
            }
            if {[variant_isset universal]} {
                ui_msg "Setting up symlinks for architectures ${universal_archs_to_use}"
                foreach arch ${universal_archs_to_use} {
                    ui_msg "ln -s ${distname} ${worksrcpath}-${arch}"
                    ln -s ${distname} ${worksrcpath}-${arch}
                }
            }
        }
    }

    if {${os.platform} eq "darwin"} {
        build.type              gnu
        # make sure we use the latest gmake:
        build.cmd               gmake
        depends_build-append    port:gmake
    }

    # see https://bugreports.qt-project.org/browse/QTBUG-35514
    build.target

    post-patch {
        #reinplace "s|//opt//local//|${prefix}/|g" ${worksrcpath}/qtbase/src/corelib/io/qstandardpaths_mac.cpp
        if {${use_parallel_build} && [file exists ${worksrcpath}/qtbase/configure]} {
            # let qmake be build in parallel too
            reinplace "s|\"\$MAKE\")|\"\$MAKE\" -j${build.jobs})|g" ${worksrcpath}/qtbase/configure
        }
        if {${subport} ne "${name}-qtwebengine"} {
            reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/qtbase/src/corelib/io/qstandardpaths_unix.cpp
            if {[variant_isset LTO] && ${os.platform} eq "darwin"} {
                if {${CXX_mp}} {
                    reinplace "s|@LLVM_AR@|${CXX_dir}/llvm-ar-${CXX_vsuffix}|g" ${worksrcpath}/qtbase/mkspecs/common/clang.conf
                    reinplace "s|@LLVM_NM@|${CXX_dir}/llvm-nm-${CXX_vsuffix}|g" ${worksrcpath}/qtbase/mkspecs/common/clang.conf
                    # this may seem surprising, but it's the stock setting:
                    reinplace "s|@LLVM_RANLIB@|true|g" ${worksrcpath}/qtbase/mkspecs/common/clang.conf
                } elseif {${os.major} <= 13} {
                    reinplace "s|@LLVM_AR@|ar|g" ${worksrcpath}/qtbase/mkspecs/common/clang.conf
                    reinplace "s|@LLVM_NM@|nm|g" ${worksrcpath}/qtbase/mkspecs/common/clang.conf
                    reinplace "s|@LLVM_RANLIB@|ranlib|g" ${worksrcpath}/qtbase/mkspecs/common/clang.conf
                }
                # else not yet needed.
            }
            # UsingTheRightCompiler:
            reinplace -W ${worksrcpath}/qtbase/mkspecs/common "s|macportsclang++|${configure.cxx}|g" clang.conf
            reinplace -W ${worksrcpath}/qtbase/mkspecs/common "s|macportsclang|${configure.cc}|g" clang.conf
        }
    }

    if { [variant_isset universal] } {
        merger-post-destroot {
            if {[tbool is_stubport]} {
                return
            }
            foreach arch ${universal_archs_to_use} {
                set dir ${destroot}-${arch}

                foreach pcfl [glob -nocomplain ${dir}${qt_frameworks_dir}/pkgconfig/*.pc] {
                    reinplace "s|/build-${arch}/|/build/|g" ${pcfl}
                    reinplace "s|${worksrcpath}-${arch}|${worksrcpath}|g" ${pcfl}
                }

                foreach prlfl [glob -nocomplain ${dir}${qt_frameworks_dir}/*.framework/*.prl] {
                    reinplace "s|/build-${arch}/|/build/|g" ${prlfl}
                    reinplace "s|${worksrcpath}-${arch}|${worksrcpath}|g" ${prlfl}
                }

                foreach prlfl [glob -nocomplain ${dir}${qt_frameworks_dir}/*.prl] {
                    reinplace "s|/build-${arch}/|/build/|g" ${prlfl}
                    reinplace "s|${worksrcpath}-${arch}|${worksrcpath}|g" ${prlfl}
                }

                reinplace "s|${worksrcpath}-${arch}|${worksrcpath}|g" ${dir}${qt_mkspecs_dir}/modules/qt_lib_bootstrap_private.pri

                reinplace \
                    "s|^set(_qt5_corelib_extra_includes \"\${_qt5Core_install_prefix}/share/qt5//mkspecs/macx-clang.*\")$|set(_qt5_corelib_extra_includes \"\${_qt5Core_install_prefix}/share/qt5//mkspecs/macx-clang-32\" \"\${_qt5Core_install_prefix}/share/qt5//mkspecs/macx-clang\")|" \
                    ${dir}${qt_frameworks_dir}/cmake/Qt5Core/Qt5CoreConfigExtrasMkspecDir.cmake
            }
        }

        post-destroot {
            if {[tbool is_stubport]} {
                return
            }
            if {[file exists ${destroot}${qt_mkspecs_dir}/qmodule.pri]} {
                # delete preprocessor comments surrounding QT_CPU_FEATURES.i386 and QT_CPU_FEATURES.x86_64
                reinplace "/^#ifndef.*$/d" ${destroot}${qt_mkspecs_dir}/qmodule.pri
                reinplace "/^#else.*$/d"   ${destroot}${qt_mkspecs_dir}/qmodule.pri
                reinplace "/^#endif.*$/d"  ${destroot}${qt_mkspecs_dir}/qmodule.pri
            }
        }

        # The file ${prefix}/share/qt5/mkspecs/qconfig.pri is still not properly merged
        # The solution is ???.
    }

    if {${subport} ne "${name}-qtwebengine"} {
        variant harfbuzz description {Use HarfBuzz-NG to do text shaping} {
            if {${os.platform} eq "darwin"} {
                depends_lib-append port:harfbuzz
            }
            configure.args-replace \
                -no-harfbuzz       \
                -system-harfbuzz
        }
        default_variants    +harfbuzz

        variant reduce_exports description {configure with --reduce-exports (experimental)} {
            configure.args-append   --reduce-exports
        }
        if {${os.platform} eq "linux"} {
            default_variants        +reduce_exports
        }

        variant tests description {Enable tests} {
            configure.args-replace  {-nomake tests} {-make tests}
        }

        variant examples description "Build examples. This will conflict with port:${name}-examples!" {
            conflicts-append        ${name}-examples
            configure.args-replace  {-nomake examples} {-make examples}
        }

        platform darwin {
            if {${subport} ne "${name}-x11"} {
                variant mariadb55 conflicts mysql56 description {use MariaDB v5.5} {}
                variant mysql56 conflicts mariadb55 description {use MySQL v5.6} {}
                default_variants        +mariadb55
                if {[variant_isset mariadb55]} {
                    depends_lib-append  port:mariadb
                } else {
                    depends_lib-append  port:mysql56
                }
            }
        }
    }

    variant debug description {This variant forces a build made with configure.optflags="-O0 -g"} {
        foreach opt {O3 O2 Os} {
            configure.cflags-replace     -${opt} -O0
            configure.cxxflags-replace   -${opt} -O0
            configure.objcflags-replace  -${opt} -O0
            configure.objcxxflags-replace  -${opt} -O0
            configure.ldflags-replace    -${opt} -O0
        }
        if {[string match *clang* ${configure.cxx}]} {
            set debugopts "-g -fno-limit-debug-info"
        } else {
            set debugopts "-g"
        }
        configure.cflags-append     ${debugopts}
        configure.cxxflags-append   ${debugopts}
        configure.objcflags-append  ${debugopts}
        configure.objcxxflags-append  ${debugopts}
        configure.ldflags-append    ${debugopts}
    }

    variant cputuned description {Build using -O3 -march=native for optimal tuning to your CPU} {
        configure.cflags-append     -O3 -march=native
        configure.cxxflags-append   -O3 -march=native
        configure.objcflags-append  -O3 -march=native
        configure.objcxxflags-append  -O3 -march=native
        configure.ldflags-append    -O3 -march=native
    }

    build.env-append                CXX=${configure.cxx} CC=${configure.cc}
}

# link includes and libraries for each actual installed framework
proc proxy_includes_and_libs {} {
    global destroot qt_includes_dir qt_frameworks_dir qt_libs_dir qt_pkg_config_dir version
    # make sure that the target directories exist
    xinstall -m 755 -d ${destroot}${qt_includes_dir}
    xinstall -m 755 -d ${destroot}${qt_libs_dir}
#     ui_info "Exposing Framework headers via ${qt_includes_dir} and creating .dylib stubs for the frameworks"
    ui_info "Exposing Framework headers via ${qt_includes_dir}"
    foreach fixfile [exec find ${destroot}${qt_frameworks_dir} \
                         -name "*.framework" | \
                         sed -e "s@${destroot}@@g"] {

        set tf_full [strsed ${fixfile} {s@\\.framework@@}]
        set tf [strsed ${tf_full} {g@.*\/@@}]

        # link headers into ${qt_includes_dir}, removing directories
        # if they are already there first

        set inc_file ${destroot}${qt_includes_dir}/${tf}
        if {[file exists ${inc_file}]} {
            system "ls -l ${inc_file}"
            ui_msg "*Warning* replacing directory ${inc_file} with a symlink to ${tf_full}.framework/Headers!"
            file delete -force ${inc_file}
        }
        ln -s ${tf_full}.framework/Headers ${inc_file}
        if {[file exists ${destroot}${tf_full}.framework/Headers/${version}/${tf}/private] \
                && ![file exist ${destroot}${tf_full}.framework/Headers/private]} {
            # the symlink will appear also as ${inc_file}/private but since ${inc_file} is itself a symlink
            # that isn't supposed to be pointing anywhere right now we use the correct actual destination in ${destroot}
            ui_debug "ln -s ${tf_full}.framework/Headers/${version}/${tf}/private ${inc_file}/private"
            ln -s ${tf_full}.framework/Headers/${version}/${tf}/private ${destroot}${tf_full}.framework/Headers/private
        }

## This is legacy code from port:qt4-mac which is probably redundant. Keep the code around for a while in the -devel port.
## <snip>
## End link library legacy code
    }

    xinstall -m 755 -d ${destroot}${qt_pkg_config_dir}
    ui_debug "moving the pkg-config files to ${qt_pkg_config_dir}"
    foreach f [glob -nocomplain -directory ${destroot}${qt_frameworks_dir}/pkgconfig *.pc] {
        file rename ${f} ${destroot}${qt_pkg_config_dir}
    }
    xinstall -m 755 -d ${destroot}${qt_libs_dir}/
    ui_debug "moving static libraries and .prl files to ${qt_libs_dir}"
    foreach f [glob -nocomplain -directory ${destroot}${qt_frameworks_dir} *.{a,prl,la}] {
        file rename ${f} ${destroot}${qt_libs_dir}/
    }

    # link back the static libraries to where some Qt components expect them:
    foreach f [exec find ${destroot}${qt_libs_dir} \
                         -name "*.a" | \
                         sed -e "s@${destroot}@@g"] {
        ln -s ${f} ${destroot}${qt_frameworks_dir}/
    }
}

proc move_and_proxy_appbundles {} {
    global destroot prefix qt_apps_dir qt_bins_dir filespath
    platform darwin {
        # Move .apps into the applications_dir, and link each .app's
        # executable back into ${qt_bins_dir}
        set dr_qt_apps_dir ${destroot}${qt_apps_dir}
        set dr_qt_bins_dir ${destroot}${qt_bins_dir}
        xinstall -m 755 -d ${dr_qt_apps_dir}
        foreach app [glob -nocomplain ${dr_qt_bins_dir}/*.app] {
            # remove the leading stuff
            set app [lindex [split ${app} /] end]
            # move the .app
            move ${dr_qt_bins_dir}/${app} ${dr_qt_apps_dir}
            # link it back
            ln -s ${qt_apps_dir}/${app} ${dr_qt_bins_dir}
            # provide a proxy to the app's executable; symlinks won't
            # be accepted by qtchooser if the user has that port installed.
            set appName [strsed ${app} {g@\.app@@}]
            set appProxy [string tolower ${appName}]
            qt5.add_app_wrapper ${appProxy} ${appName}
            # add_app_wrapper installs to ${prefix}/bin; move the wrapper
            file rename ${destroot}${prefix}/bin/${appProxy} ${dr_qt_bins_dir}/${appProxy}
        }
    }
}

if { (${subport} eq ${name}) \
    || (${subport} eq "${name}-x11") || (${subport} eq "${name}-qtwebengine")
    || (!${QT53} && ![info exists qtwebkit_is_stub] && (${subport} eq "${name}-qtwebkit")) } {

    post-destroot {
        if {[tbool is_stubport]} {
            return
        }

        # get Qt's version numbers
        set qt_vers [split ${version} "."]
        set qt_major [lindex ${qt_vers} 0]
        set qt_minor [lindex ${qt_vers} 1]
        set qt_patch [lindex ${qt_vers} 2]

        if {${os.platform} eq "darwin"} {

#             if {![info exists qt_cmake_module_dir]} {
#                 # aargh, we're building with mcalhoun's PortGroup :-/
#                 set qt_qmake_module_dir     ${qt_libs_dir}/cmake
#             }
            # move items out of the Frameworks directory that are more appropriate to the lib directory

            proxy_includes_and_libs
            # certain applications might expect to find the following .prl files in ${qt_frameworks_dir}
            foreach fixfile { libQt5OpenGLExtensions_debug.prl libQt5PlatformSupport_debug.prl \
                                libQt5QmlDevTools.prl libQt5UiTools.prl libQt5UiTools_debug.prl } {
                if {[file exists ${destroot}${qt_libs_dir}/${fixfile}]} {
                    ln -s ${qt_libs_dir}/${fixfile} ${destroot}${qt_frameworks_dir}/${fixfile}
                }
            }

            move_and_proxy_appbundles

            if {${QT53}} {
                # create our own compiler symlinks in qt_bins_dir:
                ln -s [qt_cc] ${destroot}${qt_bins_dir}/clang
                ln -s [qt_cxx] ${destroot}${qt_bins_dir}/clang++
                # edit the build scripts to use those compilers:
                reinplace "s|${build.dir}/qtbase/bin/clang|${qt_bins_dir}/clang|g" ${destroot}${qt_mkspecs_dir}/common/clang.conf
                reinplace "s|${prefix}/bin/clang-mp-.*|${qt_bins_dir}/clang|g" ${destroot}${qt_mkspecs_dir}/qmodule.pri
                reinplace "s|${prefix}/bin/clang\+\+-mp-.*|${qt_bins_dir}/clang\+\+|g" ${destroot}${qt_mkspecs_dir}/qmodule.pri
                notes-append "Qt ${version} has been configured to use the C++ compiler ${qt_bins_dir}/clang++,\
                    which is a symlink to [qt_cxx]. Remember to update this link (and its C compiler companion, clang)\
                    if ever you upgrade your port:clang installation and remove the current version."
            } else {
                if {[file exists ${destroot}${qt_mkspecs_dir}/qmodule.pri]} {
                    # clean up the generated mkspecs/qmodule.pri:
                    # undo any symlink normalisation that introduced the clang version number into QMAKE_CC/CXX (e.g. clang++-mp-3.5)
                    reinplace "s|${prefix}/bin/clang-mp-.*|clang|g"  ${destroot}${qt_mkspecs_dir}/qmodule.pri
                    reinplace "s|${prefix}/bin/clang\+\+-mp-.*|clang\+\+|g"  ${destroot}${qt_mkspecs_dir}/qmodule.pri
                    # UsingTheRightCompiler:
                    reinplace -W ${destroot}${qt_mkspecs_dir}/common "s|${configure.cxx}|clang++|g" clang.conf
                    reinplace -W ${destroot}${qt_mkspecs_dir}/common "s|${configure.cc}|clang|g" clang.conf
                }
            }
            if {[file exists ${destroot}${qt_mkspecs_dir}/qmodule.pri]} {
                correct_qmodulepri_flags  ${destroot}${qt_mkspecs_dir}/qmodule.pri
                if {![variant_isset debug]} {
                    reinplace "s|-fno-limit-debug-info||g" ${destroot}${qt_mkspecs_dir}/qmodule.pri
                }
            }
            # experimental: don't export the SDK used to build Qt via qdevice.pri
            if {[file exists ${destroot}${qt_mkspecs_dir}/qdevice.pri]} {
                reinplace "s|^!host_build:QMAKE_MAC_SDK = |# !host_build:QMAKE_MAC_SDK = |g" \
                                    ${destroot}${qt_mkspecs_dir}/qdevice.pri
            }
        }
        platform linux {
            if {[file exists ${destroot}${qt_libs_dir}/pkgconfig]
                    && [file type ${destroot}${qt_libs_dir}/pkgconfig] eq "directory"} {
                xinstall -m 755 -d ${destroot}${qt_pkg_config_dir}
                foreach f [glob -nocomplain -directory ${destroot}${qt_libs_dir}/pkgconfig *.pc] {
                    file rename ${f} ${destroot}${qt_pkg_config_dir}
                }
                # now delete this entry so that it can be replaced with a symlink later on
                file delete -force ${destroot}${qt_libs_dir}/pkgconfig
            }
        }
        if {[info exists qt_cmake_module_dir]} {
            ui_info "fixing and moving the CMake files into ${qt_cmake_module_dir}"
            if {[file exists ${destroot}${qt_frameworks_dir}/cmake]} {
                set srcdir ${qt_frameworks_dir}
                # replace the *_install_prefix path with the correct path, but "take a detour" through ${qt_dir}
                # as an extra insurance and to show the expected Qt install location in case cmake ever finds
                # a .cmake script that doesn't below to this Qt5 port.
                set sedcmd "s|/../../../../|/../../../${qt_dir_rel}/|g"
            } else {
                set srcdir ${qt_libs_dir}
                set sedcmd "s|/../../../../../|/../../../${qt_dir_rel}/../../|g"
            }
            xinstall -v -m 755 -d ${destroot}${qt_cmake_module_dir}
            foreach d [glob -tails -nocomplain -directory ${destroot}${srcdir}/cmake *] {
                xinstall -m 755 -d ${destroot}${qt_cmake_module_dir}/${d}
                foreach f [glob -nocomplain -directory ${destroot}${srcdir}/cmake/${d} *.cmake] {
                    # ${qt_frameworks_dir} is  ${qt_dir}/Library/Frameworks while
                    # ${qt_libs_dir}       is  ${qt_dir}/lib
                    # unless modified, cmake files will point to a directory that is too high in the directory hierarchy
                    reinplace ${sedcmd} ${f}
                    file rename ${f} ${destroot}${qt_cmake_module_dir}/${d}/
                }
            }
        }
        if {[file exists ${destroot}${qt_qmake_cmd}] } {
            ln -s ${qt_qmake_cmd} ${destroot}/${prefix}/bin/qmake-qt${qt_major}
            ln -s ${qt_moc_cmd} ${destroot}/${prefix}/bin/moc-qt${qt_major}
            ln -s ${qt_uic_cmd} ${destroot}/${prefix}/bin/uic-qt${qt_major}
            ln -s ${qt_lrelease_cmd} ${destroot}/${prefix}/bin/lrelease-qt${qt_major}
        }

        if {${subport} eq "${name}-x11"} {
            file delete -force ${destroot}-tmp
            file rename ${destroot} ${destroot}-tmp
            # now cherry-pick the things we want which aren't yet installed through the main port:
            xinstall -d -m 755 ${destroot}${qt_plugins_dir}/platforminputcontexts
            file rename ${destroot}-tmp/${qt_plugins_dir}/platforminputcontexts/libcomposeplatforminputcontextplugin.dylib ${destroot}${qt_plugins_dir}/platforminputcontexts
            xinstall -d -m 755 ${destroot}${qt_plugins_dir}/platforms
            file rename ${destroot}-tmp/${qt_plugins_dir}/platforms/libqxcb.dylib ${destroot}${qt_plugins_dir}/platforms
            xinstall -d -m 755 ${destroot}${qt_plugins_dir}/xcbglintegrations
            file rename ${destroot}-tmp/${qt_plugins_dir}/xcbglintegrations/libqxcb-glx-integration.dylib \
                ${destroot}${qt_plugins_dir}/xcbglintegrations
            if {[info exists qt_cmake_module_dir]} {
                xinstall -d -m 755 ${destroot}${qt_cmake_module_dir}/Qt5Gui
                file rename ${destroot}-tmp/${qt_cmake_module_dir}/Qt5Gui/Qt5Gui_QComposePlatformInputContextPlugin.cmake \
                    ${destroot}${qt_cmake_module_dir}/Qt5Gui
                file rename ${destroot}-tmp/${qt_cmake_module_dir}/Qt5Gui/Qt5Gui_QXcbIntegrationPlugin.cmake \
                    ${destroot}${qt_cmake_module_dir}/Qt5Gui
                file rename ${destroot}-tmp/${qt_cmake_module_dir}/Qt5Gui/Qt5Gui_QXcbGlxIntegrationPlugin.cmake \
                    ${destroot}${qt_cmake_module_dir}/Qt5Gui
                xinstall -d -m 755 ${destroot}${qt_cmake_module_dir}/Qt5X11Extras
                file rename ${destroot}-tmp/${qt_cmake_module_dir}/Qt5X11Extras/Qt5X11ExtrasConfig.cmake \
                    ${destroot}${qt_cmake_module_dir}/Qt5X11Extras
                file rename ${destroot}-tmp/${qt_cmake_module_dir}/Qt5X11Extras/Qt5X11ExtrasConfigVersion.cmake \
                    ${destroot}${qt_cmake_module_dir}/Qt5X11Extras
            }
            if {[file exists ${destroot}-tmp/${qt_pkg_config_dir}/Qt5X11Extras.pc]} {
                xinstall -d -m 755 ${destroot}${qt_pkg_config_dir}
                file rename ${destroot}-tmp/${qt_pkg_config_dir}/Qt5X11Extras.pc ${destroot}${qt_pkg_config_dir}
            }
            xinstall -d -m 755 ${destroot}${qt_frameworks_dir}
            file rename ${destroot}-tmp/${qt_frameworks_dir}/QtX11Extras.framework ${destroot}${qt_frameworks_dir}
            file rename ${destroot}-tmp/${qt_frameworks_dir}/QtXcbQpa.framework ${destroot}${qt_frameworks_dir}
            xinstall -d -m 755 ${destroot}${qt_libs_dir}
            file rename ${destroot}-tmp/${qt_libs_dir}/libQtX11Extras.prl ${destroot}${qt_libs_dir}
            file rename ${destroot}-tmp/${qt_libs_dir}/libQtXcbQpa.prl ${destroot}${qt_libs_dir}
            xinstall -d -m 755 ${destroot}${qt_mkspecs_dir}/modules
            file rename ${destroot}-tmp/${qt_mkspecs_dir}/modules/qt_lib_x11extras.pri ${destroot}/${qt_mkspecs_dir}/modules
            file rename ${destroot}-tmp/${qt_mkspecs_dir}/modules/qt_lib_x11extras_private.pri ${destroot}/${qt_mkspecs_dir}/modules
            file delete -force ${destroot}-tmp
        } else {
            if {${subport} eq "${name}"} {
                xinstall -m 755 ${filespath}/qtlogging.ini ${destroot}${qt_data_dir}/qtlogging.ini
                # set up hardcoded links to places where the mainstream port:qt5-* install things
                ui_info "set up things for compatibility with the mainstream port:qt5"
                # these should be done by the main port only
                ln -s ${qt_docs_dir} ${destroot}${qt_dir}/doc
                ln -s ${qt_includes_dir} ${destroot}${qt_dir}/include
                ln -s ${qt_pkg_config_dir} ${destroot}${qt_dir}/lib/pkgconfig
                ln -s ${qt_mkspecs_dir} ${destroot}${qt_dir}/mkspecs
                ln -s ${qt_plugins_dir} ${destroot}${qt_dir}/plugins
                foreach d {imports phrasebooks qml translations} {
                    ln -s ${qt_data_dir}/${d} ${destroot}${qt_dir}/${d}
                }
            }
            # these are relevant for all other subports installing frameworks
            if {[file exists ${destroot}${qt_frameworks_dir}]} {
                foreach l [exec find ${destroot}${qt_frameworks_dir} \
                                 -name "*.framework" | \
                                 sed -e "s@${destroot}@@g"] {
                     ln -s ${l} ${destroot}${qt_dir}/lib/
                }
            }
        }
    }
}

pre-configure {
    if {[variant_exists LTO] && [variant_isset LTO]} {
        if {[file exists ${build.dir}/qtbase/mkspecs/qmodule.pri]} {
            file delete -force ${build.dir}/qtbase/mkspecs/qmodule.pri
        }
    } elseif {${QT53}} {
        setQt53Compilers
        set env(CC)         ${configure.cc}
        set env(OBJC)       ${configure.objc}
        set env(CXX)        ${configure.cxx}
        set env(OBJCXX)     ${configure.objcxx}
    }
}

proc correct_qmodulepri_flags {qmopri} {
    # if the user used configure.optflags="-something" make sure that gets added to compiler and linker
    # options qmake determines, rather than replacing all of those
    reinplace "s|QMAKE_CFLAGS = |QMAKE_CFLAGS \+= |g"  ${qmopri}
    reinplace "s|QMAKE_CXXFLAGS = |QMAKE_CXXFLAGS \+= |g"  ${qmopri}
    reinplace "s|QMAKE_LFLAGS = |QMAKE_LFLAGS \+= |g"  ${qmopri}
}

post-configure {
    if {[file exists ${build.dir}/qtbase/mkspecs/qmodule.pri]} {
        correct_qmodulepri_flags ${build.dir}/qtbase/mkspecs/qmodule.pri
    }
    if {![catch {set fd [open "${workpath}/.macports.${subport}.configure.cmd" "w"]} err]} {
        foreach var [array names ::env] {
            puts ${fd} "${var}=$::env(${var})"
        }
        puts ${fd} "[join [lrange [split ${configure.env} " "] 0 end] "\n"]\n"
        puts ${fd} "cd ${worksrcpath}"
        if {[info exists configure.post_args]} {
            puts ${fd} "${configure.cmd} ${configure.pre_args} ${configure.args} ${configure.post_args}"
        } else {
            puts ${fd} "${configure.cmd} ${configure.pre_args} ${configure.args}"
        }
    } else {
        if {[info exists fd]} {
            unset fd
        }
    }
    if {[variant_exists LTO] && [variant_isset LTO]} {
        if {${subport} eq "${name}-x11"} {
            #system -W ${build.dir} "bin/qmake -config ltcg ../${worksrcdir}/qtbase"
            system -W ${build.dir} "qtbase/bin/qmake -config ltcg ../${worksrcdir}"
            if {[info exists fd]} {
                puts ${fd} "cd ${build.dir} ; qtbase/bin/qmake -config ltcg ../${worksrcdir}"
            }
        } elseif {${subport} eq "${name}-qtwebengine"} {
            system -W ${build.dir} "${qt_qmake_cmd} -config ltcg ../${worksrcdir}/qtwebengine"
            if {[info exists fd]} {
                puts ${fd} "cd ${build.dir} ; ${qt_qmake_cmd} -config ltcg ../${worksrcdir}/qtwebengine"
            }
        } else {
            foreach qdir {qtbase qtconnectivity qtdeclarative qtenginio qtlocation qtmacextras \
                        qtmultimedia qtquick1 qtsensors qtserialport qtsvg qttools qtwebchannel \
                        qtwebsockets qtxmlpatterns} {
                xinstall -d -m 755 ${build.dir}/${qdir}
                system -W ${build.dir}/${qdir} "${build.dir}/qtbase/bin/qmake -config ltcg ../../${worksrcdir}/${qdir}"
                if {[info exists fd]} {
                    puts ${fd} "cd ${build.dir} ; ${build.dir}/qtbase/bin/qmake -config ltcg ../../${worksrcdir}/${qdir}"
                }
            }
        }
        # it's crucial that the same command is used for linking as for compiling!
        if {[file exists ${build.dir}/qtbase/mkspecs/qmodule.pri]} {
            set qfp [open ${build.dir}/qtbase/mkspecs/qmodule.pri a]
            puts $qfp "QMAKE_LINK         = ${configure.cxx}"
            puts $qfp "QMAKE_LINK_SHLIB   = ${configure.cxx}"
            puts $qfp "QMAKE_LINK_C       = ${configure.cxx}"
            puts $qfp "QMAKE_LINK_C_SHLIB = ${configure.cxx}"
            close $qfp
        }
    }
    if {!${QT53} && [file exists ${worksrcpath}/qtwebkit/.git]} {
        # Do what qmake would do during an in-tree build:
        system -W ${worksrcpath}/qtwebkit "../qtbase/bin/syncqt.pl Source -version ${version}"
    }
    if {[info exists fd]} {
        if {[file exists "${configure.dir}/.qmake.cache"]} {
            puts ${fd} "## ${configure.dir}/.qmake.cache:"
            close ${fd}
            system "cat \"${configure.dir}/.qmake.cache\" >> \"${workpath}/.macports.${subport}.configure.cmd\""
        } else {
            close ${fd}
        }
        unset fd
    }
}

pre-build {
    if {${QT53}} {
        setQt53Compilers
        set env(CC)         ${configure.cc}
        set env(OBJC)       ${configure.objc}
        set env(CXX)        ${configure.cxx}
        set env(OBJCXX)     ${configure.objcxx}
    }
}

set webcorestlib ${build.dir}/Source/WebCore/release/libWebCore.a
set compress_webcorestlib   no
pre-destroot {
    if {${QT53}} {
        setQt53Compilers
        set env(CC)         ${configure.cc}
        set env(OBJC)       ${configure.objc}
        set env(CXX)        ${configure.cxx}
        set env(OBJCXX)     ${configure.objcxx}
    }
    if {[file exists ${webcorestlib}.bz2]
            && ![file exists ${webcorestlib}]} {
        # others who like me keep the Qt5 build.dir around may appreciate the possibility to
        # reduce its size by compressing libWebCore.a (>3Gb -> ~600Mb)
        ui_info "--->  Decompressing libWebCore.a.bz2"
        system "bunzip2 -v ${webcorestlib}.bz2"
        set compress_webcorestlib yes
    }
}

subport ${name}-x11 {
    if {${os.platform} eq "darwin"} {
        depends_lib-append  port:xorg-xcb-util port:xorg-xcb-util-wm port:xorg-xcb-util-image \
                            port:xorg-xcb-util-keysyms port:xorg-xorgproto \
                            port:libxkbcommon \
                            port:xrender port:mesa
        depends_run         ${qt5_dependency}
        description         ${description} - the xcb (X11) platform plugin
        long_description    ${long_description} This port installs just the xcb \
                            platform plugin, which allows rendering to (remote) X11 servers. \
                            It is useless without port:qt5-kde or port:qt5-kde-devel.

        # extract only the qtbase component
        extract_components-append \
                            ${distname}/qtbase ${distname}/qtx11extras ${distname}/configure ${distname}/qt.pro
        if {!${QT53}} {
            extract_components-append \
                            ${distname}/.gitmodules
        }
    } else {
        ui_msg "x11 subport unsupported on ${os.platform}"
        description         unsupported on ${os.platform}
        long_description    unsupported on ${os.platform}
    }
}

subport ${name}-zz-docs {
    description         ${description} - the documentation
    long_description    ${long_description}. This subport installs the documentation \
                        and has -zz- in its name to ensure it's the last one to be \
                        processed during upgrading an existing install, so it doesn't \
                        have to rebuild anything but the documentation.\n See the port notes \
                        about Assistant stability after upgrades.

    variant html description {Install the HTML documentation in addition to the Qt help (.qch) files (obsolete variant for default behaviour)} {}
    variant qch conflicts html description {Install only the Qt help (.qch) files} {}
    variant qtwebengine description {build the qtwebengine documentation too} {}

    depends_build-append \
        path:${qt_bins_dir}/qdoc:${name}
    depends_run-append \
        path:${qt_bins_dir}/assistant:${name}-assistant

    supported_archs   noarch

    build.target      docs
    if {[variant_isset qch]} {
        destroot.target     install_qch_docs
    } else {
        default_variants    +html
        destroot.target     install_docs
    }

    if {![variant_isset qtwebengine]} {
        do_not_extract-append \
                            ${distname}/qtwebengine
    }
    patchfiles-append       ${PPREF}patch-configure-docs-no-build-qmake.diff

    default configure.dir       {${workpath}/build}
    default build.dir           {${workpath}/build}
    post-extract {
        # we'll be doing a doc build as if it were part of a full Qt build,
        # but building only the "doc" target.
        # ensure that the required binaries are available where they'd be
        # when doing a full build, as symlinks to the installed binaries.
        # This saves us from having to rebuild them.
        #
        xinstall -d -m 755 ${build.dir}/qttools/bin/
        ln -s ${qt_bins_dir}/qhelpgenerator ${build.dir}/qttools/bin/

        # For the most part, generated makefiles use ${qt_bins_dir}/qdoc.
        # There are a couple of places that look in ${worksrcpath}/qtbase/src/tools/qdoc/.
        # Also put a symlink to qmake where the configure script expects it
        xinstall -d -m 755 ${build.dir}/qtbase/bin/
        ln -s ${qt_bins_dir}/qmake ${build.dir}/qtbase/bin
        if {${QT53}} {
            ln -s ${qt_bins_dir}/qdoc ${build.dir}/qtbase/src/tools/qdoc/
            ln -s ${qt_bins_dir}/qdoc ${build.dir}/qtbase/bin
        } else {
#             ln -s ${qt_bins_dir}/qdoc ${build.dir}/qttools/src/qdoc/
            ln -s ${qt_bins_dir}/qdoc ${build.dir}/qttools/bin
            ln -s ${qt_bins_dir}/moc ${build.dir}/qtbase/bin
            ln -s ${qt_bins_dir}/rcc ${build.dir}/qtbase/bin
            ln -s ${qt_bins_dir}/uic ${build.dir}/qtbase/bin
        }

        # Without this file, the makefile ${worksrcpath}/qtwebkit/Source/WebCore/Makefile.WebCore.Target
        #    keeps generating itself over and over again.
        # This file is only created when the library is being built, however.
        if {[file exists ${worksrcpath}/qtwebkit]} {
            xinstall -d -m 755 ${worksrcpath}/qtwebkit/Source/WebCore/generated
            touch ${worksrcpath}/qtwebkit/Source/WebCore/generated/InspectorBackendCommands.qrc
        }
    }
    post-destroot {
        if {[variant_isset qch]} {
            xinstall -m 755 -d ${destroot}${prefix}/share/doc/qch
            foreach d [glob -nocomplain ${destroot}${qt_docs_dir}/*.qch] {
                set target [string map [list ${destroot} ""] ${d}]
                ln -s ${target} ${destroot}${prefix}/share/doc/qch/
            }
        }
    }
    notes-append \n\
        "Qt's Assistant has a tendency to become unstable after upgrading. This can be prevented in 2 ways:\n\
        1) remove all documentation entries for the old Qt5 version in the Preferences/Documentation page \
        *before* doing the upgrade.\n\
        2) remote ~/Library/Application Support/QtProject/Assistant in case of post-upgrade instability."
}

post-build {
    if {[variant_exists strip] && [variant_isset strip]} {
        ui_msg "--->  Stripping build"
        catch {system -W ${build.dir} \
            "find . -name \"*.\[ao\]\" -o -name \"*.dylib\" -o -name \"*.so\" | xargs strip -SX"}
    }
}

# See http://qt-project.org/doc/qt-5/sql-driver.html for info on building SQL Database Drivers

if {!${QT53}} {
  if {[info exists qtwebkit_is_stub]} {
    # add this one to the list of stub ports
    set qt5.kde_stubports [lappend qt5.kde_stubports qtwebkit]
  } else {
    subport ${name}-qtwebkit {
        description Qt5 WebKit
        long_description \
                    ${description}, QtWebEngine's deprecated predecessor.
        conflicts-append \
                    [qt5_port_conflicts qtwebkit]

        master_sites \
                http://download.qt.io/community_releases/${branch}/${version}/
        distname \
                qtwebkit-opensource-src-${version}
        distfiles \
                ${distname}${extract.suffix}
        checksums \
                rmd160  84ccf4ee1448b29ac967ca51e0dabc2ab2c48bbc \
                sha256  528a6b8b1c5095367b26e8ce4f3a46bb739e2e9913ff4dfc6ef58a04fcd73966

        depends_lib-append \
                    ${qt5_dependency}
        platform darwin {
            depends_lib-append \
                    port:leveldb
        }
        platform linux {
            PortGroup       conflicts_build 1.0
            conflicts_build leveldb
        }
        use_PortGroup qmake5 1.0
        PortGroup   xcodeversion 1.0
        minimum_xcodeversions   {10 3.2}
        if {[variant_isset debug]} {
            universal_variant   no
        }
        variant strip conflicts debug {reduce the disk footprint by stripping debug-related information (at the cost of increased build time)} {}

        # Prevent conflicting definitions of Objective-C classes in C++ code
        #    from ${qt_libs_dir}/QtCore.framework/Headers/qglobal.h
        patchfiles-append \
                    patch-qtwk-objc.diff \
                    patch-qtwk-icu.diff

        platform darwin {
            if {${os.major} < 13} {
                # untested adaptations taken from mcalhoun's port:qt5-qtwebkit;
                # shouldn't be required on 10.9 and upwards (untested).
                PortGroup   cxx11 1.1
                configure.args-delete QMAKE_MACOSX_DEPLOYMENT_TARGET=${macosx_deployment_target}
                # -mmacosx-version-min=10.7 sets the stdlib to libstdc++ unless -stdlib=libc++ is set
                # QMAKE_CXXFLAGS+=-stdlib=${configure.cxx_stdlib} is insufficient since order of switches matters
                configure.args-delete \
                    QMAKE_CXXFLAGS_CXX11-=-stdlib=libc++ \
                    QMAKE_LFLAGS_CXX11-=-stdlib=libc++
            }
            post-patch {
                # qtwebkit uses glx, libXcomposite, libXrender if they can be found
                # Ensure that test fails even if software is installed
                foreach test { glx libXcomposite libXrender } {
                    reinplace "s|return 0;|return 0;\\\n#error turn off test|g" \
                        ${worksrcpath}/Tools/qmake/config.tests/${test}/${test}.cpp
                }
            }
        }

        # QtWebKit has a dependency on jpeglib which apparently has always been somewhat
        # problematic. There's a 2012 mod to improve reliability but that appears to have
        # solved only pulling in the right library. The header is still expected to be
        # on the header search path. Add ${prefix}/include globally to ensure that, in
        # addition to defining the path to our frameworks directory.
        configure.args              QMAKE_CXXFLAGS+="-F${qt_frameworks_dir} -I${prefix}/include"
        default configure.dir       {${workpath}/build}
        configure.pre_args          ../${worksrcdir}/WebKit.pro
        default build.dir           {${workpath}/build}
        # make sure qmake is called without unwanted arguments!
        configure.cmd               ${qt_qmake_cmd}
        post-configure {
            # there is no longer any need to call syncqt.pl in order to generate interface
            # headers or to make educated guesses for files that even synqt.pl omits
            # (code stripped that was commented-out in commit b4b5b934 of this Portfile).
            # We just try to generate a more compact build
            system -W ${worksrcpath} "echo 'QMAKE_CXXFLAGS -= -O3' >> .qmake.conf"
            system -W ${worksrcpath} "echo 'QMAKE_CXXFLAGS -= -O2' >> .qmake.conf"
            system -W ${worksrcpath} "echo 'QMAKE_CXXFLAGS += -Os' >> .qmake.conf"
        }
        # don't add the "all" target because that will interfere with generation of the interface headers
        build.pre_args-delete       all
        build {
            if {[catch {system -W ${build.dir} "${build.cmd} -j${build.jobs} ${build.pre_args}"} result]} {
                # this should be redundant by now:
                # there's a chance the 1st build attempt will fail because not all interface
                # headers have been generated. We can either attempt to create via symlinks
                # or else run make a 2nd time and presume the build system will always
                # generate them then. If it does, at least they'll be exactly right.
                ui_msg "--->    Building ${subport} (take 2)"
                system -W ${build.dir} "${build.cmd} -j${build.jobs} ${build.pre_args}"
            }
        }
    }
  }
}

if {!${QT53}} {
    subport ${name}-qtwebengine {
        ###### sneak preview: push 5.7.0 with the rest of Qt still @5.6.2 ######
        # this only in port:qt5-kde-devel
        ########################################################################

        conflicts-append    [qt5_port_conflicts qtwebengine]
        description         ${description} - the QtWebEngine component
        long_description    ${long_description} This port installs the  \
                            QtWebEngine component.
        use_PortGroup       qmake5 1.0
        # see https://wiki.qt.io/QtWebEngine
        PortGroup           xcodeversion 1.0
        minimum_xcodeversions   {12 5.1}
        universal_variant   no
        # ninja is used, which has its own parallel cooker; it's called through
        # a toplevel Makefile which should not be parsed in parallel to avoid
        # some kind of process multiplication (I've seen peak CPU loads of 30 in a supposedly
        # serial build ...)
        use_parallel_build  no
        # use NINJAFLAGS to tell ninja to use the desired number (N) of parallel compile jobs
        # this still leads to CPU loads that are significantly higher than N though not more than 2x
        # If necessary we can use ninja's -l N option which limits CPU load instead of job number.
        build.args-append   NINJAFLAGS=-j${build.jobs}
        if {[variant_isset universal]} {
            # See the comments about qmake and .qmake.stash above. It is likely that the same "feature"
            # prevents us from doing cross-bitwidth (32 on 64bit and vice-versa) builds inside the Qt
            # source tree.
            ui_msg "Warning: this component doesn't currently support a universal build (probable Qt bug)"
        }
        variant strip conflicts debug {reduce the disk footprint by stripping debug-related information (at the cost of increased build time)} {}

        # the QtWebengine components is built using an included copy of ninja
        depends_lib-append \
                            ${qt5_dependency} \
                            port:snappy
        # qtwebengine/src/3rdparty/ninja/bootstrap.py calls g++ (must set CXX)
        build.env-append    CXX=${configure.cxx}

        # check if we're using the all-inclusive distribution tarball
        if {${distname} ne "qtwebengine-opensource-src-${version}"} {
            # extract only the qtwebengine component
            extract_components-append \
                            ${distname}/qtwebengine
        }

#         if {!${QT56}} {
#             # see https://codereview.qt-project.org/#/c/125968/
#             patchfiles-append   ${PPREF}patch-qtwebengine-mkspec32.diff
#             # see https://codereview.qt-project.org/#/c/127759/
#             patchfiles-append   ${PPREF}patch-handle-tbd-files.diff
#         }
        if {${distname} ne "qtwebengine-opensource-src-${version}"} {
            # at some point prior to OS X 10.11, MIDI types were unified
            # bug fixed after 5.6.1
            patchfiles-append \
                            ${PPREF}patch-qwe-midifix.diff \
                            ${PPREF}patch-qwe-bluetooth.diff
            configure.args  -Wall -r ../${worksrcdir}/qtwebengine/qtwebengine.pro \
                            QMAKE_LINK=${configure.cxx}
        } else {
            platform darwin 13 {
                # https://bugreports.qt.io/browse/QTBUG-54486
                patchfiles-append \
                            patch-qwe-build-on-109.diff
                configure.args-append \
                            QMAKE_MAC_SDK=macosx10.10
            }
            patchfiles-append \
                            patch-qwe-bluetooth-57x.diff
            configure.args  -Wall -r ../${worksrcdir}/qtwebengine.pro \
                            QMAKE_LINK=${configure.cxx}
            post-destroot {
                if {[info exists qt_version] && [vercmp ${version} ${qt_version}] != 0} {
                    reinplace "s|${version} \$\{_Qt5WebEngineCore_FIND_VERSION_EXACT\}|${qt_version} \$\{_Qt5WebEngineCore_FIND_VERSION_EXACT\}|g" \
                        ${destroot}${qt_cmake_module_dir}/Qt5WebEngineCore/Qt5WebEngineCoreConfig.cmake
                }
            }
        }
        # UsingTheRightCompiler (https://trac.macports.org/wiki/UsingTheRightCompiler)
        build.env-append    CXX=${configure.cxx}

        platform darwin {
            configure.args-append \
                            QMAKE_MACOSX_DEPLOYMENT_TARGET=${macosx_deployment_target}
        }
        configure.args-append \
                            WEBENGINE_CONFIG+=use_proprietary_codecs \
                            CONFIG-=debug \
                            WEBENGINE_CONFIG+=use_system_snappy \
                            WEBENGINE_CONFIG+=use_system_icu \
                            WEBENGINE_CONFIG+=use_system_ffmpeg
        platform linux {
            PortGroup       conflicts_build 1.0
            # does git still conflict?
            conflicts_build \
                            gettext-dev libvpx-dev
            patchfiles-append \
                            patch-qwe-disable-libvpx.diff
            configure.args-append \
                            WEBENGINE_CONFIG+=use_system_libxml
            depends_lib-append \
                            port:libxml2
        }
    }

    subport ${name}-qtwebview {
        use_PortGroup           qmake5 1.0

        description             ${description} - the Qt WebView component
        long_description        ${long_description} - the Qt WebView component.
        conflicts-append        [qt5_port_conflicts qtwebview]


        extract_components-append \
                                ${distname}/qtwebview
        depends_lib-append      ${qt5_dependency} \
                                ${qt5webengine_dependency}
        default configure.dir   {${workpath}/build}
        configure.pre_args-append \
                                ../${worksrcdir}/qtwebview/qtwebview.pro
        default build.dir       {${workpath}/build}
        platform darwin {
            post-destroot {
                proxy_includes_and_libs
            }
        }
    }
}

subport ${name}-sqlite3-plugin {
    replaced_by     ${name}-sqlite-plugin
}
if {${subport} eq "${name}-sqlite3-plugin"} {
    replaced_by     ${name}-sqlite-plugin
    PortGroup       obsolete 1.0
}

if {${QT53}} {
    # qtwebkit is a stubport before Qt 5.6.0
    set qt5.kde_stubports [lappend qt5.kde_stubports qtwebkit]
}
foreach sp ${qt5.kde_stubports} {
    subport ${name}-${sp} {
        set is_stubport     yes
        conflicts-append    [qt5_port_conflicts ${sp}]
        archive_sites
        distfiles
        depends_extract
        depends_build
        depends_run
        depends_lib         ${qt5_dependency}
        switch ${sp} {
            "docs" {
                variant html description {passed on to ${name}-zz-docs} {}
                variant qch conflicts html description {passed on to ${name}-zz-docs} {}
                description     stub\; provided by port:${name}-zz-docs
                long_description \
                                this is a stub for the Qt5 documentation, provided by port:${name}-zz-docs
                depends_lib     port:${name}-zz-docs
                depends_run     port:${name}-zz-docs
                replaced_by     port:${name}-zz-docs
            }
            "qtwebkit-examples" {
                description     stub\; part of port:${name}-examples
                long_description \
                                this is a stub for a subport that's included in port:${name}-examples
                depends_run     port:${name}-examples
            }
            "qtquick1" {
                description     ${subport} is deprecated.
                long_description \
                                ${description}
                replaced_by     ${name}-qtdeclarative
                PortGroup       obsolete 1.0
            }
            "qttools" {
                description     stub\; part of port:${name}
                long_description \
                                this is a stub subport for Qt5's ${sp} which is included in port:${name}
                depends_run-append \
                                path:${qt_bins_dir}/assistant:${name}-assistant
                # we're a stub but we still should pass through relevant variants
                variant qtwebkit description {enable QtWebKit in the Assistant} {}
            }
            "mysql-plugin" {
                PortGroup active_variants 1.1
                description     stub\; part of port:${name}
                long_description \
                                this is a stub subport for Qt5's ${sp} which is included in port:${name}
                # we're a stub but we still should pass through relevant variants
                variant mariadb55 conflicts mysql56 description {use MariaDB v5.5} {}
                variant mysql56 conflicts mariadb55 description {use MySQL v5.6} {}
                default_variants \
                                +mariadb55
                if {[variant_isset mariadb55]} {
                    require_active_variants ${qt5_dependency} mariadb55
                }
                if {[variant_isset mysql56]} {
                    require_active_variants ${qt5_dependency} mysql56
                }
            }
            default {
                description     stub\; part of port:${name}
                long_description \
                                this is a stub subport for Qt5's ${sp} component which is included in port:${name}
            }
        }
        use_configure       no
        supported_archs     noarch
        build {}
        destroot {
            xinstall -d -m 755 ${destroot}${qt_docs_dir}/installed-stubports
            system "touch ${destroot}${qt_docs_dir}/installed-stubports/${subport}"
        }
    }
    if {${subport} eq "${name}"} {
        # we could be more specific but we'll just record all the port:qt5 subports as conflicts:
        conflicts-append    qt5-${sp}
    }
}

if {${subport} eq "${name}-psql84-plugin"} {
    replaced_by     ${name}-psql-plugin
    PortGroup       obsolete 1.0
}
subport ${name}-psql84-plugin {}
subport ${name}-psql-plugin {
    use_PortGroup   qmake5 1.0

    depends_lib-append \
                    ${qt5_dependency}
    if {${os.platform} eq "darwin"} {
        # define the postgresql variants
        set pqversions {84 93 94 95}
        set pqvariant ""
        foreach pqv ${pqversions} {
            set conflist ""
            foreach v ${pqversions} {
                if {${v} ne ${pqv}} {
                    set conflist "${conflist} postgresql${v}"
                }
            }
            variant postgresql${pqv} conflicts ${conflist} description "Use postgresql${pqv}" {}
            if {[variant_isset postgresql${pqv}]} {
                set pqvariant "postgresql${pqv}"
            }
        }
        # now ensure that one is set, and that each adds the appropriate build settings
        if {${pqvariant} eq ""} {
            set pqvariant "postgresql95"
            default_variants +${pqvariant}
        }
        foreach pqv ${pqversions} {
            if {[variant_isset postgresql${pqv}]} {
                set pqvariant "postgresql${pqv}"
                depends_lib-append port:postgresql${pqv}
                configure.args-append \
                            "INCLUDEPATH+=${prefix}/include/postgresql${pqv}" \
                            "LIBS+=\"-L${prefix}/lib/postgresql${pqv} -lpq\""
            }
        }
    }
    platform linux {
        configure.args-append \
                            "INCLUDEPATH+=/usr/include/postgresql"
    }

    # extract only the qtbase component
    extract_components-append \
                            ${distname}/qtbase
    post-extract {
        file delete -force ${worksrcpath}/qtbase/mkspecs
    }
    # for single architecture, easier to use
    #    worksrcdir ${worksrcdir}/qtbase/src/plugins/sqldrivers/psql,
    #    but doesn't work for universal build
    configure.dir           ${worksrcpath}/qtbase/src/plugins/sqldrivers/psql
    build.dir               ${configure.dir}
    destroot.dir            ${configure.dir}

    post-destroot {
        if {${os.platform} eq "darwin" && [info exists qt_cmake_module_dir]} {
            xinstall -d -m 755 ${destroot}${qt_cmake_module_dir}
            move ${destroot}${qt_frameworks_dir}/cmake/Qt5Sql ${destroot}${qt_cmake_module_dir}
        }
    }
}

subport ${name}-examples {
    use_PortGroup               qmake5 1.0

    description                 ${description} - the examples
    long_description            ${long_description} The examples. NB: this port will conflict \
                                with port:${name}'s +examples variant!
    universal_variant           no

    # extract only the examples
    extract_components-append   ${distname}/qtbase/examples/            \
                                ${distname}/qtconnectivity/examples/    \
                                ${distname}/qtdeclarative/examples/     \
                                ${distname}/qtenginio/examples/         \
                                ${distname}/qtlocation/examples/        \
                                ${distname}/qtmacextras/examples/       \
                                ${distname}/qtmultimedia/examples/      \
                                ${distname}/qtquickcontrols/examples/   \
                                ${distname}/qtscript/examples/          \
                                ${distname}/qtsensors/examples/         \
                                ${distname}/qtsvg/examples/             \
                                ${distname}/qttools/examples/           \
                                ${distname}/qtxmlpatterns/examples/     \
                                ${distname}/qt3d/examples               \
                                ${distname}/qtcanvas3d/examples
    if {${QT53}} {
        extract_components-append \
                                ${distname}/qtquick1/examples/          \
                                ${distname}/qtwebkit-examples/examples/
    } else {
        extract_components-append \
                                ${distname}/qtquickcontrols2/examples/   \
                                ${distname}/qtserialbus/examples/   \
                                ${distname}/qtserialport/examples/   \
                                ${distname}/qtwebview/examples/

        variant qtwebengine description {build the qtwebengine examples too} {
            depends_lib-append          ${qt5webengine_dependency}
            extract_components-append   ${distname}/qtwebengine/examples/
        }
    }
    depends_lib-append          ${qt5_dependency}

    post-extract {
        copy ${filespath}/${PPREF}/all-examples.pro ${workpath}/${worksrcdir}/all-examples.pro
        if {![variant_isset qtwebengine]} {
            reinplace "/qtwebengine/d" ${workpath}/${worksrcdir}/all-examples.pro
        }
        file mkdir ${workpath}/build
    }

    patchfiles-append           ${PPREF}remove_icon_from_example.patch \
                                ${PPREF}remove_google_adsense.patch
    default configure.dir       {${workpath}/build}
    configure.pre_args-append   ../${worksrcdir}/all-examples.pro
    default build.dir           {${workpath}/build}
    post-destroot {
        if {${os.platform} eq "darwin"} {
            # this may be a bug since Qt 5.4.1: libgruesensor.1.dylib must be accessed through a complete path but
            # isn't stored like that in 2 dependents.
            system "install_name_tool -change libgruesensor.1.dylib ${qt_examples_dir}/sensors/grue/libgruesensor.1.dylib \
                ${destroot}${qt_examples_dir}/sensors/grue/Grue/libdeclarative_grue.dylib"
            system "install_name_tool -change libgruesensor.1.dylib ${qt_examples_dir}/sensors/grue/libgruesensor.1.dylib \
                ${destroot}${qt_examples_dir}/sensors/grue/sensors/libqtsensors_grue.dylib"
        }
        # correct an installation glitch in Qt 5.6.0:
        if {[file exists ${destroot}${worksrcpath}/qtsvg/examples/svg/richtext/textobject/files/heart.svg]} {
            ui_info "NB: Moving heart.svg to its designated location"
            xinstall -m 755 -d ${destroot}${qt_examples_dir}/svg/richtext/textobject/files
            file rename ${destroot}${worksrcpath}/qtsvg/examples/svg/richtext/textobject/files/heart.svg \
                ${destroot}${qt_examples_dir}/svg/richtext/textobject/files/heart.svg
        }
    }
}

subport ${name}-settingseditor {
    use_PortGroup               qmake5 1.0
#     qt5.depends_component qtbase qtsvg qtwebkit

    description                 ${description} - the settings editor from the examples
    long_description            The settings editor from the examples of port:${name}. \
                                It can edit both native (binary) .plists and cross-platform .ini \
                                files.
    universal_variant           no
    conflicts-append            [qt5_port_conflicts settingseditor]

    # extract only the examples
    extract_components-append   ${distname}/qtbase/examples/widgets/tools/settingseditor
    depends_lib-append          ${qt5_dependency}

    default configure.dir       {${workpath}/build}
    configure.pre_args-append   ../${worksrcdir}/qtbase/examples/widgets/tools/settingseditor/settingseditor.pro
    default build.dir           {${workpath}/build}
    post-destroot {
        if {${os.platform} eq "darwin"} {
            file rename ${destroot}${qt_examples_dir}/widgets/tools/settingseditor/settingseditor.app \
                ${destroot}${qt_apps_dir}
        } else {
            file rename ${destroot}${qt_examples_dir}/widgets/tools/settingseditor/settingseditor \
                ${destroot}${qt_apps_dir}
        }
    }
}

subport ${name}-assistant {
    use_PortGroup               qmake5 1.0
    description                 ${description} - the documentation browser
    long_description            Qt Assistant is the documentation browser from the QtTools component. \
                                Its full feature set and optimum rendering depends on the now deprecated \
                                QtWebKit component.
    universal_variant           no
    conflicts-append            [qt5_port_conflicts assistant]

    # extract only the examples
    extract_components-append   ${distname}/qttools/src/assistant ${distname}/qttools/src/shared
    depends_lib-append          ${qt5_dependency}

    variant qtwebkit description {build the full-featured version that uses QtWebKit for rendering} {}
    if {[variant_isset qtwebkit]} {
        qt5.depends_component   qtwebkit
        patchfiles-append       ${PPREF}patch-assistant-with-qtwebkit.diff
    } else {
        patchfiles-append       ${PPREF}patch-assistant-without-qtwebkit.diff
    }

    patchfiles-append           ${PPREF}patch-fontpanel.diff

    default configure.dir       {${workpath}/build}
    configure.pre_args-append   ../${worksrcdir}/qttools/src/assistant/assistant/assistant.pro
    default build.dir           {${workpath}/build}
    destroot {
        # sic, we destroot to qt_bins_dir; post-destroot will correct this
        xinstall -m 755 -d ${destroot}${qt_bins_dir}
        if {${os.platform} eq "darwin"} {
            file copy ${build.dir}/Assistant.app ${destroot}${qt_bins_dir}
            qt5.add_app_wrapper assistant-qt5 Assistant
        } else {
            xinstall -m 755 ${build.dir}/assistant ${destroot}${qt_bins_dir}
            qt5.add_app_wrapper assistant-qt5 assistant assistant ${qt_bins_dir}
        }
    }
    post-destroot {
        move_and_proxy_appbundles
    }
}

post-destroot {
    # store the configuration information. NB: this could have gone in one of the above post-destroot
    # blocks where we know that ${build.dir}/qtbase is available ...
    if {[file exists ${build.dir}/qtbase]} {
        xinstall -m 755 -d ${destroot}${qt_docs_dir}/${subport}
        foreach l [glob -nocomplain ${build.dir}/qtbase/config.s*] {
            set fn [file tail ${l}]
            xinstall -m 644 ${l} ${destroot}${qt_docs_dir}/${subport}/${fn}
            xinstall -m 644 ${l} ${destroot}${qt_docs_dir}/${subport}/${fn}
        }
    }
    if {${compress_webcorestlib}} {
        ui_info "--->  Re-compressing libWebCore.a"
        system "bzip2 -9v ${webcorestlib} &"
    }

    xinstall -m 755 -d ${destroot}${qt_install_registry}
    system "echo ${version} > ${destroot}${qt_install_registry}/${subport}"
    if {${subport} eq "${name}"} {
        xinstall -m 755 -d ${destroot}${qt_install_registry}/family
        ln -s ../${subport}  ${destroot}${qt_install_registry}/family/${basename}
    }
}

post-activate {
    set pgroup_files {"qt5-1.0.tcl" "qt5-kde-1.0.tcl" "qt5-mac-1.0.tcl" "qmake5-1.0.tcl" "qmake5-kde-1.0.tcl"}
    ui_msg "Don't forget to copy the following file(s) into your main port tree's _resources directory:"
    foreach pg ${pgroup_files} {
        ui_msg "\t${qt5::currentportgroupdir}/${pg}"
    }
    ui_msg "(That's probably ${prefix}/var/macports/sources/rsync.macports.org/release/ports/_resources/port1.0/group"
    ui_msg "or ${prefix}/var/macports/sources/rsync.macports.org/release/tarballs/ports/_resources/port1.0/group/"
    ui_msg "or ${prefix}/var/macports/sources/svn.macports.org/trunk/dports/_resources/port1.0/group)"
}

livecheck.type      regex
livecheck.url       http://download.qt.io/archive/qt/${branch}/
livecheck.regex     (\\d+(\\.\\d+)+)
