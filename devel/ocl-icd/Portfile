PortSystem      1.0
PortGroup       github 1.0
set LTO.allow_ThinLTO no
PortGroup       LTO 1.0

github.setup    Ocl-dev ocl-icd fdde6677b21329432db8b481e2637cd10f7d3cb2
version         2.2.3.112 ; revision 1
distname        ${name}-git

fetch.type      git

categories      devel
platforms       darwin linux
license         BSD-2-Clause
maintainers     gmail.com:rjvbertin openmaintainer
description     OpenCL ICD Loader
long_description \
                an open source alternative to vendor-specific OpenCL ICD loaders.

depends_build-append \
                port:autoconf port:automake port:libtool
platform darwin {
    depends_build-append \
                port:xmlto
}

pre-configure {
    if {![file exists ${worksrcpath}/configure]} {
        system -W ${worksrcpath} ./bootstrap
    }
}

configure.args-append \
                --disable-silent-rules \
                --enable-pthread-once \
			 --enable-official-khronos-headers \
			 --enable-custom-vendordir=${prefix}/etc/OpenCL/vendors \
			 --enable-custom-layerdir=${prefix}/etc/OpenCL/layers \
			 --disable-update-database

destroot.keepdirs \
                ${destroot}${prefix}/etc/OpenCL/vendors \
                ${destroot}${prefix}/etc/OpenCL/layers

post-activate {
    foreach i [glob -nocomplain /etc/OpenCL/vendors/*.icd] {
        if {![file exists ${prefix}${i}]} {
            ln -s ${i} ${prefix}/etc/OpenCL/vendors/
            ui_msg "--->   Linked from system: ${i}"
        }
    }
    foreach i [glob -nocomplain /etc/OpenCL/layers/*] {
        if {![file exists ${prefix}${i}]} {
            ln -s ${i} ${prefix}/etc/OpenCL/layers/
            ui_msg "--->   Linked from system: ${i}"
        }
    }
    ui_msg "--->   (Done)"
}
