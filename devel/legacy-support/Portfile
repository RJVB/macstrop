# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           makefile 1.0
# PortGroup           muniversal 1.1
set LTO_needs_pre_build yes
set LTO.allow_ThinLTO   no
set LTO.fat_LTO_Objects yes
PortGroup           LTO 1.0
PortGroup           save_configure_cmd 1.0

name                legacy-support
categories          devel
platforms           darwin

maintainers         {mascguy @mascguy} \
                    {fwright.net:fw @fhgwright} \
                    openmaintainer
license             MIT BSD APSL-2

description         Installs wrapper headers and a runtime library to add \
                    missing functionality to legacy OSX versions.
long_description    {*}${description}

# Introduced to roll back to 1.0.13 release due to issues with 1.1.0.
# Must now stay.
epoch               1

# Primary release version
set release_ver     1.5.2

# Binary compatibility version
set compat_ver      1.0.0

subport ${name} {
    conflicts           ${name}-devel
    github.setup        macports macports-legacy-support ${release_ver} v
    github.tarball_from archive
    revision            0
    checksums           rmd160  58a9837f78a72cb2204d674cc41e028b10bff71b \
                        sha256  16da882281d26d8ddfb434acfde0828fc3e4119aab332445f65688ae879e9962 \
                        size    228427
}

subport ${name}-devel {
    conflicts           ${name}
    github.setup        macports macports-legacy-support \
                        f89c155cbc2ca8714e4ada66c11b222353e8d87a
    github.tarball_from archive
    version             20250924
    revision            0
    livecheck.type      none
    checksums           rmd160  3d6ca0af242f859e201c387bde0b0e9aa6ce7883 \
                        sha256  37c8483ac0594a009e1509f4ddd2eff42c4707cedba58a8ec34bcf779834e144 \
                        size    228476
    set v_split         [split ${release_ver} .]
    set release_ver     [lindex ${v_split} 0].[lindex ${v_split} 1].99
}

# Set up proper arch list for build and test
if {![variant_isset universal]} {
    set archs       ${configure.build_arch}
} else {
    set archs       ${configure.universal_archs}
}

# Let the Makefile handle the archs setup
configure.cc_archflags
configure.cxx_archflags
configure.ld_archflags
configure.universal_cflags
configure.universal_cxxflags
configure.universal_ldflags

# Pass the arch list to the Makefile
build.env-append        ARCHS=${archs}
destroot.env-append     ARCHS=${archs}
test.env-append         ARCHS=${archs}

# Set test target for optional universal handling
# For some reason, setting test.target doesn't work.
test.pre_args       test_unv

# Enable parallel tests
default test.jobs   ${build.jobs}
test.post_args      -j${test.jobs}

# The makefile PG brings in the unnecessary compiler_wrapper PG.
# Disable it to reduce logfile clutter and obfuscation.
#
compwrap.compilers_to_wrap

# This port doesn't use C++ at all, except for two very limited tests
# that are manual-only.  Disabling cxx_stdlib avoids unnessary compiler
# constraints on some platforms.
#
configure.cxx_stdlib

patch.pre_args      -Np1
patchfiles-append   patch-ARFLAGS.diff \
                    patch-ccrandomgeneratebytes-runtime-symbol.diff \
                    patch-rjvbs-clonefile-runtime-functions.diff

# for a newer lipo:
depends_build-append port:cctools

# set host_os_version ${macosx_deployment_target}
# variant sdk10.7 description {build as if on OS X 10.7} {}
# if {[variant_isset sdk10.7]} {
#     set macosx_deployment_target    10.7
#     configure.sdk_version           ${macosx_deployment_target}
#     set extraflags          -D__MPLS_TARGET_OSVER=1070
# }
# if {${host_os_version} ne ${macosx_deployment_target}} {
#     ui_warn "Building for ${configure.sdk_version}!"
#     configure.sdkroot       [portconfigure::configure_get_sdkroot ${configure.sdk_version}]
#     # somehow we need to invoke this twice?!
#     configure.sdkroot       [portconfigure::configure_get_sdkroot ${configure.sdk_version}]
#     set extraflags          "${extraflags} \
#                             -mmacosx-version-min=${macosx_deployment_target} \
#                             -isysroot${configure.sdkroot}"
#     configure.cflags-append   {*}${extraflags}
#     configure.cxxflags-append {*}${extraflags}
#     configure.ldflags-append  {*}${extraflags}
# }

if {[tbool configure.ccache]} {
    build.env-append \
                    "CXX=ccache ${configure.cxx}" \
                    "CC=ccache ${configure.cc}" \
} else {
    build.env-append \
                    CXX=${configure.cxx} \
                    CC=${configure.cc} \
}
# yes, we deactivate the default OPT
build.env-append    PREFIX=${prefix} \
                    OPT= \
                    "LIPO=${prefix}/bin/lipo" \
                    ARX=${configure.ar} \
                    LD=/opt/local/bin/ld \
                    PLATFORM=${os.major} \
                    SOCURVERSION=${release_ver} \
                    SOCOMPATVERSION=${compat_ver}

# build static library without LTO
# see https://trac.macports.org/ticket/69480
build.post_args-append \
                    SLIBCFLAGS=-fno-lto
destroot.env        PREFIX=${prefix}

LTO.configure.flags_append {cflags cxxflags ldflags} ${LTO.cpuflags}

# Include Tiger-specific additions
platform darwin 8 {
    build.target-append     tiger-bins
    destroot.target-append  install-tiger

    # Avoid troublesome Xcode 2.5 linker on 10.4
    configure.compiler      apple-gcc-4.2
}

# Include Leopard-specific additions
platform darwin 9 {
    build.target-append     leopard-bins
    destroot.target-append  install-leopard
}

# if {${universal_possible} && [variant_isset universal]} {
#     foreach arch ${muniversal.architectures} {
#         build.env.${arch}-append    FORCE_ARCH=${arch}
#     }
# }

configure.save_build_cmd "install"

test.env            {*}${build.env}
test.run            yes
test.target         test

if {![file exists ${prefix}/libexec/mpstats]} {
    notes "
    To help make sure your system continues to be well-represented by\
    MacPorts, especially if your system is not one of the latest macOS\
    releases, please consider installing mpstats.  It will periodically\
    send an anonymous synopsis of your OS settings and installed ports.\
    The information provided by this is useful to help determine how\
    resources are allocated.

    You can install mpstats like this:    sudo port install mpstats
    "
}
