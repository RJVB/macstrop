# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.1
PortGroup           qt5 1.0
PortGroup           cmake 1.1

name                zeal
description         A docset browser written in Qt.
long_description    Zeal is an offline documentation browser inspired by Dash

subport zeal-devel  {}
if {${subport} eq "${name}-devel"} {
    conflicts       ${name}
    long_description-append \
                    The latest version which really requires the more resource-hungry \
                    QtWebEngine in order to work smoothly (instead of sluggishly). The \
                    main value-added feature over port:zeal is the addition of an HTTP \
                    server which allows to display documentation in the default web browser.
    github.setup    zealdocs zeal a91528508b454a05a7aed30198ac388e64d09604
    fetch.type      git
    version         0.7.2.59
    worksrcdir      ${name}-git
    distname        ${name}-git
    set PPREFIX     devel/
    depends_lib-append \
                    port:sqlite3
    depends_build-append \
                    path:share/ECM/cmake/ECMConfig.cmake:kde-extra-cmake-modules
    compiler.cxx_standard \
                    2017
    platform darwin {
        if {[string match macports-gcc* ${configure.compiler}]} {
            pre-configure {
                ui_warn "GCC 12 and 13 have been known to cause crashes when importing docsets from Apple documentation!"
            }
        }
    }
} else {
    conflicts       ${name}-devel
    # v0.6.1-134-g4a302077f8d5536655b12703f84d743666733475 would be the last commit
    # before the port to QtWebEngine. Something in 0.7.2.x makes Zeal use a lot of CPU,
    # esp. on Mac where as a results it's slower on a 2nd gen i7 than on a lowly N3150 .
    # Sadly, 0.6.1.134 is still slower than 0.6.1.93, without clear benefits beyond
    # the http server.
    github.setup    zealdocs zeal b27a57d4438dcabd86e6673bf2eded4ca4f193be
    fetch.type      git
    version         0.6.1.93
    distname        ${name}-git
    set PPREFIX     ./
}

categories          devel

maintainers         gmail.com:rjvbertin mk openmaintainer
platforms           darwin linux
license             GPL-3

homepage            https://zealdocs.org

installs_libs       no

depends_lib-append  port:libarchive

patch.pre_args      -Np1

patchfiles-append   patch-macports-install.diff \
                    ${PPREFIX}patch-macports-update-checking.diff
if {${subport} eq "${name}-devel"} {
    patchfiles-append \
                    devel/patch-toplevel-cmakelists.diff \
                    devel/patch-restore-libarchive-extraction.diff
    if {[vercmp [qt5.active_version] 5.15.2] < 0} {
        patchfiles-append \
                    devel/patch-support-qt59.diff
    }
    # bring back support for QtWebKit!
    patchfiles-append \
                    devel/patch-support-qtwebkit.diff
    patchfiles-append \
                    devel/patch-nosandbox-option.diff
    patchfiles-append \
                    devel/patch-limit-zoomfactor.diff

} else {
    patchfiles-append \
                    ${PPREFIX}patch-toplevel-cmakelists.diff \
                    ${PPREFIX}patch-restore-libarchive-extraction.diff \
                    devel/patch-limit-zoomfactor.diff
    # later versions have a different kind of docset install/update progress
    # reporting and don't let the user close the docsets dialog during that.
    # We keep the old-style progress bar, and only disable the [Close] button
    # until everyone has been downloaded and extracted. Also shows progress
    # reporting during the extraction phases.
    patchfiles-append \
                    ${PPREFIX}patch-noclose-during-docset-extraction.diff
}
post-patch {
    reinplace "s|@VERSION@|${version}|g" ${worksrcpath}/CMakeLists.txt
}

variant webkit conflicts webengine description {use the (legacy) Qt WebKit backend} {

    qt5.depends_component \
                    qtwebkit
    configure.args-append \
                    -DUSE_WEBKIT=ON
}

if {${subport} eq "${name}-devel"} {
    variant webengine conflicts webkit description {use the Qt WebEngine backend} {
        qt5.depends_component \
                    qtwebengine
        configure.args-append \
                    -DUSE_WEBKIT=OFF
    }
}

configure.args-append \
                    -DZEAL_RELEASE_BUILD=ON \
                    -DZEAL_USE_QT5=ON

if {[variant_exists webengine] && ![variant_isset webkit]} {
    default_variants    +webengine
} else {
    default_variants    +webkit
}

if {![variant_isset webkit] && ![variant_isset webengine]} {
    ui_error "You need to select either the +webkit or the +webengine variant"
    return -code error "Unsupported configuration"
}

if {${os.platform} eq "darwin"} {
    post-destroot {
        xinstall -m 755 -d ${destroot}${qt_apps_dir}
        if {${subport} eq "${name}-devel"} {
            file rename ${build.dir}/Zeal.app ${destroot}${qt_apps_dir}/
        } else {
            file rename ${build.dir}/bin/Zeal.app ${destroot}${qt_apps_dir}/
        }
        file delete -force ${destroot}${qt_apps_dir}/Zeal.app/Contents/MacOS/Zeal.dSYM
        file delete -force ${destroot}${prefix}/bin/zeal.icns
        if {[info procs qt5.add_app_wrapper] ne ""} {
            qt5.add_app_wrapper zeal Zeal
        }
    }
} else {
    cmake.install_rpath-prepend \
                    ${qt_libs_dir}
    post-destroot {
        file rename ${destroot}${prefix}/bin/zeal ${destroot}${prefix}/bin/zeal.bin
        qt5.add_app_wrapper zeal zeal.bin "" ${prefix}/bin
    }
}

build.post_args -wk
