# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup legacysupport 1.1
PortGroup           LTO 1.0
PortGroup           save_configure_cmd 1.0

name                nasm
version             3.01
categories          lang
license             BSD
maintainers         nomaintainer
platforms           darwin linux

description         NASM, the Netwide Assembler, is an 80x86 and x86-64 assembler

long_description    The Netwide Assembler, NASM, is an 80x86 and x86−64 \
                    assembler designed for portability and modularity. It \
                    supports a range of object file formats, including Linux \
                    and *BSD a.out, ELF, COFF, Mach−O, 16−bit and 32−bit OBJ \
                    (OMF) format, Win32 and Win64. It will also output plain \
                    binary files, Intel hex and Motorola S−Record formats. Its \
                    syntax is designed to be simple and easy to understand, \
                    similar to the syntax in the Intel Software Developer \
                    Manual with minimal complexity. It supports all currently \
                    known x86 architectural extensions, and has strong support \
                    for macros. NASM used to come with a set of utilities for \
                    handling the RDOFF custom object−file format; those are now \
                    in port:rdoff-tools.

installs_libs       no

# for realpath
legacysupport.newest_darwin_requires_legacy 9

homepage            https://www.nasm.us
master_sites        ${homepage}/pub/nasm/releasebuilds/${version}
use_bzip2           yes

checksums           rmd160  85ec02a69ed74bdcb0aab6646253c13062a5a49e \
                    sha256  7a7b1ff3b0eef3247862f2fbe4ca605ccef770545d7af7979eba84a9d045c0b1
#                     size    1960877

# Has no dependencies and user-supplied CPPFLAGS are inserted into the build
# system in the incorrect place (before the project's own -I flags rather
# than after) so clear our unneeded flags because they would cause a build
# failure if certain other ports (such as libmd) are installed.
configure.cppflags-delete   -I${prefix}/include
configure.ldflags-delete    -L${prefix}/lib

destroot.target     install
destroot.destdir    prefix=${destroot}${prefix}

subport rdoff-tools {}
if {${subport} eq "rdoff-tools"} {
    description     The RDOFF utilities shipped with older NASM versions
    long_description {*}${description}

    version         2.15.05
    checksums       rmd160  feaf4c2dccec0d4ab1ed18f799ec72c91d5bd13b \
                    sha256  3c4b8339e5ab54b1bcb2316101f8985a5da50a3f9e504d43fa6f35668bee2fd0

    # probably not true but the easiest way to prevent a conflict situation with pre-2.16 nasm installs:
    depends_run-append \
                    port:nasm

    destroot.target install_rdf
    livecheck.type  none
    return
}

configure.args-append \
                    --enable-year2038

livecheck.type      regex
livecheck.url       ${homepage}/doc/nasmdocc.html
livecheck.regex     {Version ([0-9.]+)</h4>}
